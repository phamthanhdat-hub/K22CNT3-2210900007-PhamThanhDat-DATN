<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gi·ªè h√†ng | BabyCutie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/gio-hang.css">
</head>
<body>

<header class="header">
    <div class="container header-wrap">
        <div class="logo" onclick="location='index.html'">
            <img src="images/logo2.jpg">
            <span>BabyCutie</span>
        </div>
        <button class="btn-login" onclick="location='thuc-don.html'">
            ‚Üê Ti·∫øp t·ª•c mua
        </button>
    </div>
</header>

<section class="container mt-4">
    <h2>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

    <table class="table bg-white mt-3">
        <thead>
            <tr>
                <th>S·∫£n ph·∫©m</th>
                <th>Gi√°</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>T·∫°m t√≠nh</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="cartBody"></tbody>
    </table>

    <h4 class="text-end">
        T·ªïng ti·ªÅn: <span id="tongTien">0</span>ƒë
    </h4>

    <!-- ===== NH·∫¨P M√É KHUY·∫æN M√ÉI ===== -->
    <div class="mt-3">
        <input type="text" id="maKhuyenMai" placeholder="Nh·∫≠p m√£ khuy·∫øn m√£i">
        <button onclick="apDungKhuyenMai()">√Åp d·ª•ng</button>
    </div>

    <!-- ===== PH∆Ø∆†NG TH·ª®C THANH TO√ÅN ===== -->
    <div class="mt-3">
        <label>
            <input type="radio" name="pttt" value="COD" checked>
            Thanh to√°n khi nh·∫≠n h√†ng (COD)
        </label>
        <br>
        <label>
            <input type="radio" name="pttt" value="Chuy·ªÉn kho·∫£n">
            Chuy·ªÉn kho·∫£n ng√¢n h√†ng
        </label>
    </div>

    <button class="btn-primary mt-3" onclick="datHang()">
        ƒê·∫∑t h√†ng & Thanh to√°n
    </button>
</section>

<!-- ================= JS GI·ªé H√ÄNG (NH√öNG TR·ª∞C TI·∫æP) ================= -->
<script>
/* ===============================
   GI·ªé H√ÄNG ‚Äì D·ª∞A CSDL CHAO BABY CUTIE
================================ */

// demo: sau login b·∫°n n√™n l∆∞u nguoiDung_id
const nguoiDung_id = 2; // Nguy·ªÖn Th·ªã Lan (demo)

const cartBody = document.getElementById("cartBody");
const tongTienEl = document.getElementById("tongTien");

/* ===============================
   LOAD GI·ªé H√ÄNG
================================ */
function loadCart() {
    fetch(`http://127.0.0.1:5000/api/gio-hang/${nguoiDung_id}`)
        .then(res => res.json())
        .then(data => {
            cartBody.innerHTML = "";
            let tong = 0;

            if (!data || data.length === 0) {
                cartBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align:center">
                            üõí Gi·ªè h√†ng tr·ªëng
                        </td>
                    </tr>
                `;
                tongTienEl.innerText = 0;
                return;
            }

            data.forEach(item => {
                const tamTinh = item.gia * item.soLuong;
                tong += tamTinh;

                cartBody.innerHTML += `
                <tr>
                    <td>${item.tenSanPham}</td>
                    <td>${item.gia.toLocaleString()}ƒë</td>
                    <td>
                        <input type="number" min="1"
                            value="${item.soLuong}"
                            onchange="updateQty(${item.gioHang_id}, this.value)">
                    </td>
                    <td>${tamTinh.toLocaleString()}ƒë</td>
                    <td>
                        <button onclick="removeItem(${item.gioHang_id})">‚ùå</button>
                    </td>
                </tr>
                `;
            });

            tongTienEl.innerText = tong.toLocaleString();
        })
        .catch(err => {
            console.error(err);
            alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c gi·ªè h√†ng");
        });
}

/* ===============================
   C·∫¨P NH·∫¨T S·ªê L∆Ø·ª¢NG
================================ */
function updateQty(id, soLuong) {
    fetch(`http://127.0.0.1:5000/api/gio-hang/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ soLuong: soLuong })
    }).then(loadCart);
}

/* ===============================
   X√ìA S·∫¢N PH·∫®M
================================ */
function removeItem(id) {
    fetch(`http://127.0.0.1:5000/api/gio-hang/${id}`, {
        method: "DELETE"
    }).then(loadCart);
}

/* ===============================
   ƒê·∫∂T H√ÄNG + THANH TO√ÅN
================================ */
function datHang() {
    const phuongThuc = document.querySelector(
        "input[name='pttt']:checked"
    ).value;

    fetch("http://127.0.0.1:5000/api/don-hang", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            nguoiDung_id: nguoiDung_id,
            diaChiGiaoHang: "TP H·ªì Ch√≠ Minh"
        })
    })
    .then(res => res.json())
    .then(data => {
        return fetch("http://127.0.0.1:5000/api/thanh-toan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                donHang_id: data.donHang_id,
                phuongThuc: phuongThuc
            })
        });
    })
    .then(res => res.json())
    .then(() => {
        alert("üéâ ƒê·∫∑t h√†ng & thanh to√°n th√†nh c√¥ng!");
        loadCart();
    })
    .catch(err => {
        alert("C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng!");
        console.error(err);
    });
}

/* ===============================
   √ÅP D·ª§NG KHUY·∫æN M√ÉI
================================ */
function apDungKhuyenMai() {
    const ma = document.getElementById("maKhuyenMai").value;

    if (!ma) {
        alert("Vui l√≤ng nh·∫≠p m√£ khuy·∫øn m√£i");
        return;
    }

    fetch("http://127.0.0.1:5000/api/don-hang")
        .then(res => res.json())
        .then(ds => {
            const donHangMoiNhat = ds.find(d => d.hoTen);

            return fetch("http://127.0.0.1:5000/api/khuyen-mai/ap-dung", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    donHang_id: donHangMoiNhat.id,
                    maKhuyenMai: ma
                })
            });
        })
        .then(res => res.json())
        .then(data => {
            alert(
                "√Åp m√£ th√†nh c√¥ng! Gi·∫£m: " +
                data.soTienGiam.toLocaleString() + "ƒë"
            );
            document.getElementById("tongTien").innerText =
                data.tongTienMoi.toLocaleString();
        })
        .catch(() => {
            alert("M√£ kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n");
        });
}

/* ===============================
   LOAD BAN ƒê·∫¶U
================================ */
loadCart();
</script>

</body>
</html>
