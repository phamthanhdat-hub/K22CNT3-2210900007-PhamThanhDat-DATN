<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gi·ªè h√†ng | BabyCutie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/gio-hang.css">
</head>
<body>

<header class="header">
    <div class="container header-wrap">
        <div class="logo" onclick="location='index.html'">
            <img src="images/logo2.jpg">
            <span>BabyCutie</span>
        </div>
        <button class="btn-login" onclick="location='thuc-don.html'">
            ‚Üê Ti·∫øp t·ª•c mua
        </button>
    </div>
</header>

<section class="container mt-4">
    <h2>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

    <table class="table bg-white mt-3">
        <thead>
            <tr>
                <th>S·∫£n ph·∫©m</th>
                <th>Gi√°</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>T·∫°m t√≠nh</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="cartBody"></tbody>
    </table>

    <h4 class="text-end">
        T·ªïng ti·ªÅn: <span id="tongTien">0</span>ƒë
    </h4>

    <!-- ===== NH·∫¨P M√É KHUY·∫æN M√ÉI ===== -->
    <div class="mt-3">
        <input type="text" id="maKhuyenMai" placeholder="Nh·∫≠p m√£ khuy·∫øn m√£i">
        <button onclick="apDungKhuyenMai()">√Åp d·ª•ng</button>
    </div>

    <!-- ===== PH∆Ø∆†NG TH·ª®C THANH TO√ÅN ===== -->
    <div class="mt-3">
        <label>
            <input type="radio" name="pttt" value="COD" checked>
            Thanh to√°n khi nh·∫≠n h√†ng (COD)
        </label>
        <br>
        <label>
            <input type="radio" name="pttt" value="Chuy·ªÉn kho·∫£n">
            Chuy·ªÉn kho·∫£n ng√¢n h√†ng
        </label>
    </div>

    <button class="btn-primary mt-3" onclick="datHang()">
        ƒê·∫∑t h√†ng & Thanh to√°n
    </button>
</section>

<!-- ================= JS GI·ªé H√ÄNG (NH√öNG TR·ª∞C TI·∫æP) ================= -->
<script>
const API_GIO_HANG = "http://127.0.0.1:5000/api/gio-hang";
const IMAGE_URL = "http://127.0.0.1:5000/images/";
const token = localStorage.getItem("token");

if (!token) {
    alert("Vui l√≤ng ƒëƒÉng nh·∫≠p");
    window.location.href = "login-khach.html";
}

const cartBody = document.getElementById("cartBody");
const tongTienEl = document.getElementById("tongTien");

/* ===============================
   LOAD GI·ªé H√ÄNG
================================ */
function loadCart() {
    fetch(API_GIO_HANG, {
        headers: {
            "Authorization": "Bearer " + token
        }
    })
    .then(res => res.json())
    .then(data => {
        cartBody.innerHTML = "";
        let tong = 0;

        if (data.length === 0) {
            cartBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align:center">
                        üõí Gi·ªè h√†ng tr·ªëng
                    </td>
                </tr>
            `;
            tongTienEl.innerText = 0;
            return;
        }

        data.forEach(item => {
            const tamTinh = item.gia * item.soLuong;
            tong += tamTinh;

            cartBody.innerHTML += `
                <tr>
                    <td>
                        <img src="${IMAGE_URL + item.hinhAnh}" width="60"><br>
                        ${item.tenSanPham}
                    </td>
                    <td>${item.gia.toLocaleString()}ƒë</td>
                    <td>
                        <input type="number" min="1"
                            value="${item.soLuong}"
                            onchange="updateQty(${item.gioHang_id}, this.value)">
                    </td>
                    <td>${tamTinh.toLocaleString()}ƒë</td>
                    <td>
                        <button onclick="removeItem(${item.gioHang_id})">‚ùå</button>
                    </td>
                </tr>
            `;
        });

        tongTienEl.innerText = tong.toLocaleString();
    });
}

/* ===============================
   UPDATE / DELETE
================================ */
function updateQty(id, soLuong) {
    fetch(`${API_GIO_HANG}/${id}`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ soLuong })
    }).then(loadCart);
}

function removeItem(id) {
    fetch(`${API_GIO_HANG}/${id}`, {
        method: "DELETE",
        headers: {
            "Authorization": "Bearer " + token
        }
    }).then(loadCart);
}

/* ===============================
   √ÅP D·ª§NG KHUY·∫æN M√ÉI
================================ */
let donHangId = null;
let soTienGiam = 0;

function apDungKhuyenMai() {
    const maKM = document.getElementById("maKhuyenMai").value.trim();
    if (!maKM) {
        alert("Vui l√≤ng nh·∫≠p m√£ khuy·∫øn m√£i");
        return;
    }

    // T·∫°o ƒë∆°n h√†ng t·∫°m n·∫øu ch∆∞a c√≥
    if (!donHangId) {
        taoDonHangTam().then(id => {
            if (id) {
                donHangId = id;
                apDungKMChoDonHang(id, maKM);
            }
        });
    } else {
        apDungKMChoDonHang(donHangId, maKM);
    }
}

function apDungKMChoDonHang(dhId, maKM) {
    fetch("http://127.0.0.1:5000/api/khuyen-mai/ap-dung", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            donHang_id: dhId,
            maKhuyenMai: maKM
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            soTienGiam = data.soTienGiam || 0;
            alert(`√Åp d·ª•ng th√†nh c√¥ng! Gi·∫£m ${new Intl.NumberFormat('vi-VN').format(soTienGiam)}ƒë`);
            loadCart();
        } else {
            alert(data.message || "Kh√¥ng th·ªÉ √°p d·ª•ng m√£ khuy·∫øn m√£i");
        }
    })
    .catch(err => {
        alert("L·ªói: " + err.message);
    });
}

function taoDonHangTam() {
    const userInfo = JSON.parse(localStorage.getItem("user_info") || '{}');
    return fetch("http://127.0.0.1:5000/api/don-hang", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            nguoiDung_id: userInfo.id,
            diaChiGiaoHang: ""
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            return data.donHang_id;
        }
        return null;
    });
}

/* ===============================
   ƒê·∫∂T H√ÄNG & THANH TO√ÅN
================================ */
function datHang() {
    const userInfo = JSON.parse(localStorage.getItem("user_info") || '{}');
    const phuongThuc = document.querySelector('input[name="pttt"]:checked').value;
    const diaChi = prompt("Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng:") || "";

    if (!diaChi.trim()) {
        alert("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng");
        return;
    }

    // T·∫°o ƒë∆°n h√†ng
    fetch("http://127.0.0.1:5000/api/don-hang", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            nguoiDung_id: userInfo.id,
            diaChiGiaoHang: diaChi
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const dhId = data.donHang_id;
            
            // Thanh to√°n
            return fetch("http://127.0.0.1:5000/api/thanh-toan/thanh-toan", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    donHang_id: dhId,
                    phuongThuc: phuongThuc
                })
            });
        } else {
            throw new Error(data.message || "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!");
            window.location.href = "don-hang-cua-toi.html";
        } else {
            alert(data.message || "Thanh to√°n th·∫•t b·∫°i");
        }
    })
    .catch(err => {
        alert("L·ªói: " + err.message);
        console.error(err);
    });
}

/* ===============================
   LOAD BAN ƒê·∫¶U
================================ */
loadCart();
</script>


</body>
</html>
