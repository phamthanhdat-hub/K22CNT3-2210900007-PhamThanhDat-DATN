<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gi·ªè h√†ng | BabyCutie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/gio-hang.css">
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<header class="header">
    <div class="container header-wrap">
        <div class="logo" onclick="location='index.html'">
            <img src="images/logo2.jpg">
            <span>BabyCutie</span>
        </div>
        
        <!-- SEARCH -->
        <div class="search">
            <i class="fa fa-search" id="searchIcon" onclick="handleSearch(event)"></i>
            <input type="text" id="searchInput" placeholder="T√¨m m√≥n ƒÉn cho b√©..." onkeyup="handleSearch(event)">
        </div>
        
        <button class="btn-login" onclick="location='thuc-don.html'">
            ‚Üê Ti·∫øp t·ª•c mua
        </button>
    </div>
</header>

<section class="container mt-4">
    <h2>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

    <div class="row g-4">
        <!-- ===== C·ªòT TR√ÅI: DANH S√ÅCH S·∫¢N PH·∫®M ===== -->
        <div class="col-lg-8">
            <div class="cart-items-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <span id="cartItemCount">0</span> m√≥n ƒÉn trong gi·ªè
                    </h5>
                    <a href="thuc-don.html" class="btn btn-link text-decoration-none">
                        <i class="fa fa-arrow-left"></i> Ti·∫øp t·ª•c mua s·∫Øm
                    </a>
                </div>

                <div class="cart-items-list" id="cartItemsList">
                    <!-- S·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
                </div>
            </div>
        </div>

        <!-- ===== C·ªòT PH·∫¢I: T√ìM T·∫ÆT ƒê∆†N H√ÄNG ===== -->
        <div class="col-lg-4">
            <div class="order-summary-section">
                <h5 class="mb-3">üìã T√≥m t·∫Øt ƒë∆°n h√†ng</h5>

                <!-- M√£ gi·∫£m gi√° -->
                <div class="promo-code-box mb-3">
                    <label class="form-label small mb-2">M√£ gi·∫£m gi√°</label>
                    <div class="d-flex gap-2">
                        <input 
                            type="text" 
                            id="maKhuyenMai" 
                            class="form-control form-control-sm" 
                            placeholder="Nh·∫≠p m√£">
                        <button class="btn btn-sm btn-primary" onclick="apDungKhuyenMai()">
                            √Åp d·ª•ng
                        </button>
                    </div>
                    <div id="promoInfo" class="mt-2 small text-success" style="display: none;"></div>
                </div>

                <!-- T·ªïng ph·ª• -->
                <div class="summary-row">
                    <span>T·ªïng ph·ª•</span>
                    <span id="tongPhu">0‚Ç´</span>
                </div>

                <!-- Ph√≠ v·∫≠n chuy·ªÉn -->
                <div class="summary-row">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                    <span id="phiVanChuyen">15.000‚Ç´</span>
                </div>

                <!-- Gi·∫£m gi√° -->
                <div class="summary-row text-success" id="giamGiaRow">
                    <span>ƒê√£ gi·∫£m gi√°</span>
                    <span id="giamGia">-0‚Ç´</span>
                </div>

                <!-- T·ªïng c·ªông -->
                <div class="summary-row total-row">
                    <span class="fw-bold">T·ªïng c·ªông</span>
                    <span class="fw-bold text-primary" id="tongCong">0‚Ç´</span>
                </div>
                <p class="small text-muted mb-3">(ƒê√£ bao g·ªìm VAT)</p>

                <!-- N√∫t thanh to√°n -->
                <button class="btn btn-primary w-100 btn-checkout" onclick="goToCheckout()" id="checkoutBtn">
                    Ti·∫øn h√†nh thanh to√°n <i class="fa fa-arrow-right"></i>
                </button>

                <!-- Icons th√¥ng tin -->
                <div class="info-icons mt-4">
                    <div class="info-item">
                        <i class="fa fa-check-circle text-success"></i>
                        <span>Thanh to√°n an to√†n</span>
                    </div>
                    <div class="info-item">
                        <i class="fa fa-truck text-primary"></i>
                        <span>Giao h√†ng nhanh ch√≥ng</span>
                    </div>
                    <div class="info-item">
                        <i class="fa fa-utensils text-warning"></i>
                        <span>Ch·∫ø bi·∫øn t∆∞∆°i ngon</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- ===== TH√îNG TIN GIAO H√ÄNG (·∫®N - S·∫º HI·ªÜN ·ªû TRANG THANH TO√ÅN) ===== -->
<div class="mt-3 customer-info-section" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 style="margin: 0; color: #ff6b81; font-weight: 700;">
                <i class="fa fa-user-circle"></i> Th√¥ng tin giao h√†ng
            </h5>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadCustomerInfo()" title="T·∫£i l·∫°i th√¥ng tin ƒë√£ l∆∞u">
                <i class="fa fa-refresh"></i> T·∫£i l·∫°i th√¥ng tin
            </button>
        </div>
        <form id="customerInfoForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">
                        <i class="fa fa-user"></i> H·ªç v√† t√™n <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="hoTen" 
                            class="form-control" 
                            placeholder="Nh·∫≠p h·ªç v√† t√™n"
                            required
                            autocomplete="name"
                            style="cursor: text;">
                        <button type="button" class="btn btn-outline-secondary" onclick="clearField('hoTen')" title="X√≥a">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    <div class="invalid-feedback">Vui l√≤ng nh·∫≠p h·ªç v√† t√™n</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">
                        <i class="fa fa-phone"></i> S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <input 
                            type="tel" 
                            id="dienThoai" 
                            class="form-control" 
                            placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                            required
                            pattern="[0-9]{10,11}"
                            autocomplete="tel"
                            style="cursor: text;">
                        <button type="button" class="btn btn-outline-secondary" onclick="clearField('dienThoai')" title="X√≥a">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    <div class="invalid-feedback">Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá (10-11 s·ªë)</div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">
                    <i class="fa fa-map-marker-alt"></i> ƒê·ªãa ch·ªâ giao h√†ng <span class="text-danger">*</span>
                </label>
                <div class="position-relative">
                    <textarea 
                        id="diaChi" 
                        class="form-control" 
                        rows="3" 
                        placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng chi ti·∫øt (s·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë)"
                        required
                        autocomplete="street-address"
                        style="cursor: text; resize: vertical; padding-right: 45px;"></textarea>
                    <button type="button" class="btn btn-sm btn-outline-secondary position-absolute" onclick="clearField('diaChi')" title="X√≥a" style="top: 8px; right: 8px; z-index: 10;">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="invalid-feedback">Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng</div>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="saveInfo" checked>
                <label class="form-check-label" for="saveInfo">
                    <i class="fa fa-save"></i> L∆∞u th√¥ng tin n√†y cho l·∫ßn mua sau
                </label>
            </div>
            <div class="alert alert-info mb-0">
                <i class="fa fa-info-circle"></i> 
                <strong>L∆∞u √Ω:</strong> B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a th√¥ng tin giao h√†ng b·∫•t c·ª© l√∫c n√†o tr∆∞·ªõc khi ƒë·∫∑t h√†ng.
            </div>
        </form>
    </div>

</section>

<!-- MODAL QR CODE CHUY·ªÇN KHO·∫¢N -->
<div class="modal fade" id="qrPaymentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff6b81, #ff8fa3); color: #fff;">
                <h5 class="modal-title">
                    <i class="fa fa-qrcode"></i> Thanh to√°n chuy·ªÉn kho·∫£n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="bank-info mb-4">
                    <h6 class="mb-3">
                        <i class="fa fa-university"></i> Th√¥ng tin t√†i kho·∫£n ng√¢n h√†ng
                    </h6>
                    <div class="bank-details">
                        <p>
                            <strong><i class="fa fa-user"></i> Ch·ªß t√†i kho·∫£n:</strong> 
                            <span id="accountHolder" class="fw-bold" style="color: #ff6b81; font-size: 16px;">PH·∫†M TH√ÄNH ƒê·∫†T</span>
                        </p>
                        <p>
                            <strong><i class="fa fa-phone"></i> S·ªë ƒëi·ªán tho·∫°i:</strong> 
                            <span id="phoneNumber" class="fw-bold" style="color: #ff6b81; font-size: 16px;">0984868340</span>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('0984868340')">
                                <i class="fa fa-copy"></i> Copy
                            </button>
                        </p>
                        <p>
                            <strong><i class="fa fa-money-bill-wave"></i> S·ªë ti·ªÅn:</strong> 
                            <span id="paymentAmount" class="text-danger fw-bold" style="font-size: 20px;">0ƒë</span>
                        </p>
                        <p>
                            <strong><i class="fa fa-file-text"></i> N·ªôi dung chuy·ªÉn kho·∫£n:</strong> 
                            <span id="paymentContent" class="text-muted fw-bold">DonHang#</span>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyPaymentContent()">
                                <i class="fa fa-copy"></i> Copy
                            </button>
                        </p>
                    </div>
                </div>
                
                <div class="qr-code-container mb-4">
                    <h6 class="mb-3">
                        <i class="fa fa-qrcode"></i> Qu√©t m√£ QR ƒë·ªÉ thanh to√°n
                    </h6>
                    <div class="qr-image-wrapper">
                        <img src="images/qr.jpg" alt="QR Code thanh to√°n" id="qrImage" 
                             style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);">
                    </div>
                    <p class="text-muted mt-3" style="font-size: 14px;">
                        <i class="fa fa-info-circle"></i> 
                        Vui l√≤ng qu√©t m√£ QR b·∫±ng ·ª©ng d·ª•ng ng√¢n h√†ng (VietQR, Momo, Napas 247) ho·∫∑c ·ª©ng d·ª•ng ng√¢n h√†ng c·ªßa b·∫°n
                    </p>
                </div>

                <div class="payment-steps">
                    <div class="step-item">
                        <div class="step-number">1</div>
                        <p>Qu√©t m√£ QR b·∫±ng app ng√¢n h√†ng</p>
                    </div>
                    <div class="step-item">
                        <div class="step-number">2</div>
                        <p>Ki·ªÉm tra s·ªë ti·ªÅn v√† n·ªôi dung chuy·ªÉn kho·∫£n</p>
                    </div>
                    <div class="step-item">
                        <div class="step-number">3</div>
                        <p>X√°c nh·∫≠n thanh to√°n</p>
                    </div>
                </div>

                <div class="alert alert-info mt-4">
                    <i class="fa fa-clock"></i> 
                    <strong>L∆∞u √Ω:</strong> Sau khi chuy·ªÉn kho·∫£n, vui l√≤ng ch·ªù 5-10 ph√∫t ƒë·ªÉ h·ªá th·ªëng x√°c nh·∫≠n. 
                    ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω sau khi nh·∫≠n ƒë∆∞·ª£c thanh to√°n.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeQRModal()">
                    <i class="fa fa-times"></i> ƒê√≥ng
                </button>
                <button type="button" class="btn btn-primary" id="confirmTransferBtn" onclick="confirmBankTransfer(event)">
                    <i class="fa fa-check"></i> ƒê√£ chuy·ªÉn kho·∫£n
                </button>
            </div>
        </div>
    </div>
</div>
</section>

<!-- ================= JS GI·ªé H√ÄNG (NH√öNG TR·ª∞C TI·∫æP) ================= -->
<script>
const API_GIO_HANG = "http://127.0.0.1:5000/api/gio-hang";
const IMAGE_URL = "http://127.0.0.1:5000/images/";
const token = localStorage.getItem("token");

if (!token) {
    alert("Vui l√≤ng ƒëƒÉng nh·∫≠p");
    window.location.href = "login-khach.html";
}

const PHI_VAN_CHUYEN = 15000;
let selectedKhuyenMai = null;

/* ===============================
   LOAD GI·ªé H√ÄNG
================================ */
function loadCart() {
    // Ki·ªÉm tra token
    if (!token) {
        console.error("No token found");
        alert("Vui l√≤ng ƒëƒÉng nh·∫≠p");
        window.location.href = "login-khach.html";
        return;
    }

    console.log("Loading cart with token:", token.substring(0, 20) + "...");

    const cartItemsList = document.getElementById("cartItemsList");
    const cartItemCount = document.getElementById("cartItemCount");
    const checkoutBtn = document.getElementById("checkoutBtn");

    // Hi·ªÉn th·ªã loading
    if (cartItemsList) {
        cartItemsList.innerHTML = `
            <div class="text-center py-5">
                <i class="fa fa-spinner fa-spin fa-2x text-primary"></i>
                <p class="mt-3">ƒêang t·∫£i gi·ªè h√†ng...</p>
            </div>
        `;
    }

    fetch(API_GIO_HANG, {
        method: "GET",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        }
    })
    .then(res => {
        console.log("Response status:", res.status);
        
        // Ki·ªÉm tra status code
        if (res.status === 401) {
            console.error("Unauthorized - token expired or invalid");
            alert("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
            localStorage.removeItem("token");
            localStorage.removeItem("user_info");
            window.location.href = "login-khach.html";
            return null;
        }
        if (!res.ok) {
            console.error("HTTP error:", res.status, res.statusText);
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
        console.log("Cart data received:", data);
        
        // Ki·ªÉm tra n·∫øu data l√† null (do l·ªói 401)
        if (data === null) return;

        // Ki·ªÉm tra n·∫øu data l√† object c√≥ message (l·ªói)
        if (data && typeof data === 'object' && data.message && !Array.isArray(data)) {
            console.error("API Error:", data.message);
            if (cartItemsList) {
                cartItemsList.innerHTML = `
                    <div class="empty-cart-state">
                        <i class="fa fa-exclamation-triangle text-warning"></i>
                        <h4>L·ªói t·∫£i gi·ªè h√†ng</h4>
                        <p class="text-muted">${data.message}</p>
                        <button class="btn btn-primary mt-3" onclick="loadCart()">
                            <i class="fa fa-refresh"></i> Th·ª≠ l·∫°i
                        </button>
                    </div>
                `;
            }
            return;
        }

        // ƒê·∫£m b·∫£o data l√† array
        if (!Array.isArray(data)) {
            console.error("Invalid data format - expected array, got:", typeof data, data);
            if (cartItemsList) {
                cartItemsList.innerHTML = `
                    <div class="empty-cart-state">
                        <i class="fa fa-exclamation-triangle text-warning"></i>
                        <h4>L·ªói ƒë·ªãnh d·∫°ng d·ªØ li·ªáu</h4>
                        <p class="text-muted">Vui l√≤ng th·ª≠ l·∫°i sau</p>
                        <button class="btn btn-primary mt-3" onclick="loadCart()">
                            <i class="fa fa-refresh"></i> Th·ª≠ l·∫°i
                        </button>
                    </div>
                `;
            }
            return;
        }

        console.log("Cart items count:", data.length);

        let tong = 0;

        if (data.length === 0) {
            if (cartItemsList) {
                cartItemsList.innerHTML = `
                    <div class="empty-cart-state">
                        <i class="fa fa-shopping-cart"></i>
                        <h4>Gi·ªè h√†ng tr·ªëng</h4>
                        <p class="text-muted">B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng</p>
                        <a href="thuc-don.html" class="btn btn-primary mt-3">
                            <i class="fa fa-shopping-bag"></i> Ti·∫øp t·ª•c mua s·∫Øm
                        </a>
                    </div>
                `;
            }
            if (cartItemCount) cartItemCount.textContent = "0";
            updateOrderSummary(0);
            if (checkoutBtn) checkoutBtn.disabled = true;
            return;
        }

        // Enable button thanh to√°n
        if (checkoutBtn) checkoutBtn.disabled = false;

        // Clear v√† render l·∫°i
        if (cartItemsList) cartItemsList.innerHTML = "";
        
        data.forEach(item => {
            // Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
            if (!item.gioHang_id || !item.tenSanPham || !item.gia || !item.soLuong) {
                console.warn("Invalid cart item:", item);
                return;
            }

            const tamTinh = item.gia * item.soLuong;
            tong += tamTinh;

            if (cartItemsList) {
                cartItemsList.innerHTML += `
                    <div class="cart-item-card">
                        <div class="cart-item-image">
                            <img src="${IMAGE_URL + (item.hinhAnh || 'default.jpg')}" alt="${item.tenSanPham}" 
                                 onerror="this.src='${IMAGE_URL}default.jpg'">
                        </div>
                        <div class="cart-item-info">
                            <h6 class="cart-item-name">${item.tenSanPham}</h6>
                            <div class="cart-item-price">${Number(item.gia).toLocaleString()}‚Ç´</div>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="qty-btn qty-btn-minus" onclick="updateQty(${item.gioHang_id}, ${item.soLuong - 1})" ${item.soLuong <= 1 ? 'disabled' : ''}>
                                ‚àí
                            </button>
                            <span class="qty-value">${item.soLuong}</span>
                            <button class="qty-btn qty-btn-plus" onclick="updateQty(${item.gioHang_id}, ${item.soLuong + 1})">
                                +
                            </button>
                        </div>
                        <div class="cart-item-subtotal">
                            <strong>${tamTinh.toLocaleString()}‚Ç´</strong>
                        </div>
                        <div class="cart-item-actions">
                            <button class="btn-remove" onclick="removeItem(${item.gioHang_id})" title="X√≥a">
                                X
                            </button>
                        </div>
                    </div>
                `;
            }
        });

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
        if (cartItemCount) cartItemCount.textContent = data.length;
        
        // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
        updateOrderSummary(tong);
        
        // C·∫≠p nh·∫≠t cart count tr√™n header
        updateHeaderCartCount();
        
        console.log("Cart loaded successfully. Total items:", data.length, "Total amount:", tong);
    })
    .catch(err => {
        console.error("Error loading cart:", err);
        console.error("Error details:", err.message, err.stack);
        if (cartItemsList) {
            cartItemsList.innerHTML = `
                <div class="empty-cart-state">
                    <i class="fa fa-exclamation-triangle text-danger"></i>
                    <h4>L·ªói k·∫øt n·ªëi</h4>
                    <p class="text-muted">Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i.</p>
                    <p class="text-muted small">Chi ti·∫øt: ${err.message}</p>
                    <button class="btn btn-primary mt-3" onclick="loadCart()">
                        <i class="fa fa-refresh"></i> Th·ª≠ l·∫°i
                    </button>
                </div>
            `;
        }
    });
}

/* ===============================
   C·∫¨P NH·∫¨T CART COUNT TR√äN HEADER
================================ */
function updateHeaderCartCount() {
    const cartCountEl = document.getElementById("cartCount");
    if (!cartCountEl) return;

    fetch(API_GIO_HANG, {
        headers: {"Authorization": "Bearer " + token}
    })
    .then(res => res.json())
    .then(data => {
        const total = data.reduce((sum, item) => sum + item.soLuong, 0);
        cartCountEl.textContent = total;
        
        if (total > 0) {
            cartCountEl.style.display = "flex";
            cartCountEl.classList.add("bounce");
            setTimeout(() => cartCountEl.classList.remove("bounce"), 500);
        } else {
            cartCountEl.style.display = "none";
        }
    })
    .catch(err => {
        console.error("Error updating header cart count:", err);
        if (cartCountEl) cartCountEl.textContent = "0";
    });
}

// Toast notification function
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type} show`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
    }, 3000);
}

/* ===============================
   UPDATE / DELETE
================================ */
function updateQty(id, soLuong) {
    // Validation
    if (soLuong <= 0) {
        showToast("S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0", "error");
        loadCart(); // Reload ƒë·ªÉ reset v·ªÅ gi√° tr·ªã c≈©
        return;
    }

    fetch(`${API_GIO_HANG}/${id}`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ soLuong: parseInt(soLuong) })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast("‚úÖ ƒê√£ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng", "success");
            loadCart();
            updateHeaderCartCount();
        } else {
            showToast(data.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng", "error");
            loadCart(); // Reload ƒë·ªÉ reset
        }
    })
    .catch(err => {
        showToast("‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i", "error");
        loadCart();
    });
}

function removeItem(id) {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?")) {
        return;
    }

    fetch(`${API_GIO_HANG}/${id}`, {
        method: "DELETE",
        headers: {
            "Authorization": "Bearer " + token
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast("‚úÖ ƒê√£ x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng", "success");
            loadCart();
            updateHeaderCartCount();
        } else {
            showToast(data.message || "Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m", "error");
            loadCart();
        }
    })
    .catch(err => {
        showToast("‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i", "error");
        loadCart();
    });
}

/* ===============================
   C·∫¨P NH·∫¨T T√ìM T·∫ÆT ƒê∆†N H√ÄNG
================================ */
function updateOrderSummary(tongPhu) {
    const phiVanChuyen = PHI_VAN_CHUYEN;
    const giamGia = selectedKhuyenMai ? selectedKhuyenMai.soTienGiam : 0;
    const tongCong = tongPhu + phiVanChuyen - giamGia;

    document.getElementById("tongPhu").textContent = tongPhu.toLocaleString() + "‚Ç´";
    document.getElementById("phiVanChuyen").textContent = phiVanChuyen.toLocaleString() + "‚Ç´";
    
    if (giamGia > 0) {
        document.getElementById("giamGiaRow").classList.add("show");
        document.getElementById("giamGia").textContent = "-" + giamGia.toLocaleString() + "‚Ç´";
    } else {
        document.getElementById("giamGiaRow").classList.remove("show");
    }
    
    document.getElementById("tongCong").textContent = tongCong.toLocaleString() + "‚Ç´";
}

/* ===============================
   √ÅP D·ª§NG KHUY·∫æN M√ÉI
================================ */
function apDungKhuyenMai() {
    const maKM = document.getElementById("maKhuyenMai").value.trim().toUpperCase();
    if (!maKM) {
        showToast("Vui l√≤ng nh·∫≠p m√£ khuy·∫øn m√£i", "error");
        return;
    }

    // T√≠nh t·ªïng ti·ªÅn hi·ªán t·∫°i t·ª´ gi·ªè h√†ng
    const tongPhuEl = document.getElementById("tongPhu");
    const tongTien = parseInt(tongPhuEl.textContent.replace(/[^\d]/g, '')) || 0;

    if (tongTien === 0) {
        showToast("Gi·ªè h√†ng tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m", "error");
        return;
    }

    // T√≠nh to√°n khuy·∫øn m√£i
    fetch("http://127.0.0.1:5000/api/khuyen-mai/tinh-toan", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
            maKhuyenMai: maKM,
            tongTien: tongTien
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            selectedKhuyenMai = {
                id: data.khuyenMai_id,
                maKhuyenMai: data.maKhuyenMai,
                tenKhuyenMai: data.tenKhuyenMai,
                soTienGiam: data.soTienGiam
            };
            
            // C·∫≠p nh·∫≠t t√≥m t·∫Øt ƒë∆°n h√†ng
            const tongPhu = parseInt(document.getElementById("tongPhu").textContent.replace(/[^\d]/g, '')) || 0;
            updateOrderSummary(tongPhu);
            
            // Hi·ªÉn th·ªã th√¥ng tin khuy·∫øn m√£i
            const promoInfo = document.getElementById("promoInfo");
            promoInfo.style.display = "block";
            promoInfo.innerHTML = `<i class="fa fa-check-circle"></i> ƒê√£ √°p d·ª•ng m√£ "${data.maKhuyenMai}" - Gi·∫£m ${data.soTienGiam.toLocaleString()}‚Ç´`;
            
            showToast(`‚úÖ √Åp d·ª•ng m√£ "${data.maKhuyenMai}" th√†nh c√¥ng! Gi·∫£m ${new Intl.NumberFormat('vi-VN').format(data.soTienGiam)}ƒë`, "success");
            
            // Disable input v√† button
            document.getElementById("maKhuyenMai").disabled = true;
            document.querySelector('button[onclick="apDungKhuyenMai()"]').disabled = true;
            
            // Th√™m n√∫t x√≥a khuy·∫øn m√£i
            addRemovePromoButton();
        } else {
            showToast(data.message || "Kh√¥ng th·ªÉ √°p d·ª•ng m√£ khuy·∫øn m√£i", "error");
        }
    })
    .catch(err => {
        showToast("‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i", "error");
        console.error("Promo error:", err);
    });
}

function updateTongTienWithPromo(tongTienSauGiam, soTienGiam) {
    const tongTienEl = document.getElementById("tongTien");
    const originalTongTien = parseInt(tongTienEl.getAttribute("data-original") || tongTienEl.textContent.replace(/[^\d]/g, ''));
    
    // L∆∞u t·ªïng ti·ªÅn g·ªëc n·∫øu ch∆∞a c√≥
    if (!tongTienEl.getAttribute("data-original")) {
        tongTienEl.setAttribute("data-original", originalTongTien);
    }
    
    // Hi·ªÉn th·ªã t·ªïng ti·ªÅn sau gi·∫£m
    tongTienEl.textContent = new Intl.NumberFormat('vi-VN').format(tongTienSauGiam) + "ƒë";
    
    // Th√™m hi·ªÉn th·ªã th√¥ng tin gi·∫£m gi√°
    let promoInfo = document.getElementById("promoInfo");
    if (!promoInfo) {
        promoInfo = document.createElement("div");
        promoInfo.id = "promoInfo";
        promoInfo.className = "text-success fw-bold mt-2";
        tongTienEl.parentElement.appendChild(promoInfo);
    }
    promoInfo.innerHTML = `üí∞ ƒê√£ gi·∫£m: <span class="text-danger">-${new Intl.NumberFormat('vi-VN').format(soTienGiam)}ƒë</span>`;
}

function addRemovePromoButton() {
    const promoSection = document.getElementById("maKhuyenMai").parentElement;
    let removeBtn = document.getElementById("removePromoBtn");
    if (!removeBtn) {
        removeBtn = document.createElement("button");
        removeBtn.id = "removePromoBtn";
        removeBtn.className = "btn btn-sm btn-outline-danger mt-2";
        removeBtn.innerHTML = '<i class="fa fa-times"></i> X√≥a m√£ khuy·∫øn m√£i';
        removeBtn.onclick = removeKhuyenMai;
        promoSection.appendChild(removeBtn);
    }
}

function removeKhuyenMai() {
    selectedKhuyenMai = null;
    
    // C·∫≠p nh·∫≠t t√≥m t·∫Øt ƒë∆°n h√†ng
    const tongPhu = parseInt(document.getElementById("tongPhu").textContent.replace(/[^\d]/g, '')) || 0;
    updateOrderSummary(tongPhu);
    
    // X√≥a th√¥ng tin promo
    const promoInfo = document.getElementById("promoInfo");
    if (promoInfo) {
        promoInfo.style.display = "none";
        promoInfo.innerHTML = "";
    }
    
    // Enable input v√† button
    document.getElementById("maKhuyenMai").disabled = false;
    document.getElementById("maKhuyenMai").value = "";
    document.querySelector('button[onclick="apDungKhuyenMai()"]').disabled = false;
    
    // X√≥a n√∫t remove
    const removeBtn = document.getElementById("removePromoBtn");
    if (removeBtn) removeBtn.remove();
    
    showToast("ƒê√£ x√≥a m√£ khuy·∫øn m√£i", "info");
}

/* ===============================
   CHUY·ªÇN ƒê·∫æN TRANG THANH TO√ÅN
================================ */
function goToCheckout() {
    const userInfo = JSON.parse(localStorage.getItem("user_info") || '{}');
    
    if (!userInfo.id) {
        showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n", "error");
        setTimeout(() => {
            window.location.href = "login-khach.html";
        }, 1500);
        return;
    }

    // L∆∞u th√¥ng tin v√†o localStorage ƒë·ªÉ chuy·ªÉn sang trang thanh to√°n
    const checkoutData = {
        tongPhu: parseInt(document.getElementById("tongPhu").textContent.replace(/[^\d]/g, '')) || 0,
        phiVanChuyen: PHI_VAN_CHUYEN,
        giamGia: selectedKhuyenMai ? selectedKhuyenMai.soTienGiam : 0,
        tongCong: parseInt(document.getElementById("tongCong").textContent.replace(/[^\d]/g, '')) || 0,
        khuyenMai: selectedKhuyenMai
    };
    
    localStorage.setItem("checkout_data", JSON.stringify(checkoutData));
    
    // Chuy·ªÉn ƒë·∫øn trang thanh to√°n
    window.location.href = "thanh-toan.html";
}

function taoDonHangTam() {
    const userInfo = JSON.parse(localStorage.getItem("user_info") || '{}');
    return fetch("http://127.0.0.1:5000/api/don-hang", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            nguoiDung_id: userInfo.id,
            diaChiGiaoHang: ""
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            return data.donHang_id;
        }
        return null;
    });
}

// Bi·∫øn l∆∞u th√¥ng tin ƒë∆°n h√†ng t·∫°m
let tempDonHangId = null;
let tempTongTien = 0;

/* ===============================
   X·ª¨ L√ù THAY ƒê·ªîI PH∆Ø∆†NG TH·ª®C THANH TO√ÅN
================================ */
function handlePaymentMethodChange() {
    const selectedMethod = document.querySelector('input[name="pttt"]:checked').value;
    const checkoutBtn = document.getElementById('checkoutBtn');
    
    if (selectedMethod === "Chuy·ªÉn kho·∫£n") {
        checkoutBtn.innerHTML = '<i class="fa fa-qrcode"></i> Xem m√£ QR & ƒê·∫∑t h√†ng';
    } else {
        checkoutBtn.innerHTML = '<i class="fa fa-credit-card"></i> ƒê·∫∑t h√†ng & Thanh to√°n';
    }
}

/* ===============================
   LOAD TH√îNG TIN KH√ÅCH H√ÄNG
================================ */
function loadCustomerInfo() {
    const userInfo = JSON.parse(localStorage.getItem("user_info") || '{}');
    
    // ƒê·∫£m b·∫£o c√°c tr∆∞·ªùng c√≥ th·ªÉ ch·ªânh s·ª≠a
    document.getElementById("hoTen").disabled = false;
    document.getElementById("dienThoai").disabled = false;
    document.getElementById("diaChi").disabled = false;
    
    if (userInfo.hoTen) {
        document.getElementById("hoTen").value = userInfo.hoTen;
    }
    if (userInfo.dienThoai) {
        document.getElementById("dienThoai").value = userInfo.dienThoai;
    }
    if (userInfo.diaChi) {
        document.getElementById("diaChi").value = userInfo.diaChi;
    }
    
    // X√≥a c√°c class validation c≈©
    document.getElementById("hoTen").classList.remove("is-valid", "is-invalid");
    document.getElementById("dienThoai").classList.remove("is-valid", "is-invalid");
    document.getElementById("diaChi").classList.remove("is-valid", "is-invalid");
    
    showToast("‚úÖ ƒê√£ t·∫£i l·∫°i th√¥ng tin giao h√†ng", "success");
}

/* ===============================
   X√ìA TR∆Ø·ªúNG NH·∫¨P LI·ªÜU
================================ */
function clearField(fieldId) {
    const field = document.getElementById(fieldId);
    if (field) {
        field.value = "";
        field.classList.remove("is-valid", "is-invalid");
        field.focus();
    }
}

/* ===============================
   VALIDATE TH√îNG TIN KH√ÅCH H√ÄNG
================================ */
function validateCustomerInfo() {
    const hoTen = document.getElementById("hoTen").value.trim();
    const dienThoai = document.getElementById("dienThoai").value.trim();
    const diaChi = document.getElementById("diaChi").value.trim();

    let isValid = true;

    // Validate h·ªç t√™n
    if (!hoTen || hoTen.length < 2) {
        document.getElementById("hoTen").classList.add("is-invalid");
        isValid = false;
    } else {
        document.getElementById("hoTen").classList.remove("is-invalid");
        document.getElementById("hoTen").classList.add("is-valid");
    }

    // Validate s·ªë ƒëi·ªán tho·∫°i
    const phonePattern = /^[0-9]{10,11}$/;
    if (!dienThoai || !phonePattern.test(dienThoai)) {
        document.getElementById("dienThoai").classList.add("is-invalid");
        isValid = false;
    } else {
        document.getElementById("dienThoai").classList.remove("is-invalid");
        document.getElementById("dienThoai").classList.add("is-valid");
    }

    // Validate ƒë·ªãa ch·ªâ
    if (!diaChi || diaChi.length < 10) {
        document.getElementById("diaChi").classList.add("is-invalid");
        isValid = false;
    } else {
        document.getElementById("diaChi").classList.remove("is-invalid");
        document.getElementById("diaChi").classList.add("is-valid");
    }

    if (!isValid) {
        showToast("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß v√† ch√≠nh x√°c th√¥ng tin giao h√†ng", "error");
        // Scroll to first invalid field
        const firstInvalid = document.querySelector(".is-invalid");
        if (firstInvalid) {
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalid.focus();
        }
    }

    return isValid;
}

/* ===============================
   C·∫¨P NH·∫¨T TH√îNG TIN KH√ÅCH H√ÄNG
================================ */
function updateCustomerInfo() {
    const userInfo = JSON.parse(localStorage.getItem("user_info") || '{}');
    const saveInfo = document.getElementById("saveInfo").checked;

    if (!saveInfo || !userInfo.id) {
        return Promise.resolve();
    }

    const hoTen = document.getElementById("hoTen").value.trim();
    const dienThoai = document.getElementById("dienThoai").value.trim();
    const diaChi = document.getElementById("diaChi").value.trim();

    // C·∫≠p nh·∫≠t v√†o localStorage
    userInfo.hoTen = hoTen;
    userInfo.dienThoai = dienThoai;
    userInfo.diaChi = diaChi;
    localStorage.setItem("user_info", JSON.stringify(userInfo));

    // C·∫≠p nh·∫≠t v√†o database n·∫øu user ch·ªçn l∆∞u
    return fetch("http://127.0.0.1:5000/api/auth/update-profile", {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
            id: userInfo.id,
            hoTen: hoTen,
            dienThoai: dienThoai,
            diaChi: diaChi
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            console.log("ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin v√†o database");
        }
        return Promise.resolve();
    })
    .catch(err => {
        console.error("L·ªói c·∫≠p nh·∫≠t th√¥ng tin:", err);
        return Promise.resolve(); // Kh√¥ng ch·∫∑n qu√° tr√¨nh ƒë·∫∑t h√†ng n·∫øu c·∫≠p nh·∫≠t th·∫•t b·∫°i
    });
}

/* ===============================
   ƒê·∫∂T H√ÄNG & THANH TO√ÅN
================================ */
function datHang() {
    const userInfo = JSON.parse(localStorage.getItem("user_info") || '{}');
    
    if (!userInfo.id) {
        showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng", "error");
        setTimeout(() => {
            window.location.href = "login-khach.html";
        }, 1500);
        return;
    }

    // Validate th√¥ng tin kh√°ch h√†ng
    if (!validateCustomerInfo()) {
        return;
    }

    // L·∫•y th√¥ng tin t·ª´ form
    const hoTen = document.getElementById("hoTen").value.trim();
    const dienThoai = document.getElementById("dienThoai").value.trim();
    const diaChi = document.getElementById("diaChi").value.trim();
    const phuongThuc = document.querySelector('input[name="pttt"]:checked').value;

    // C·∫≠p nh·∫≠t th√¥ng tin n·∫øu user ch·ªçn l∆∞u
    updateCustomerInfo().then(() => {
        // N·∫øu l√† COD - x·ª≠ l√Ω thanh to√°n tr·ª±c ti·∫øp
        if (phuongThuc === "COD") {
            processCODOrder(userInfo.id, hoTen, dienThoai, diaChi);
            return;
        }

        // N·∫øu l√† Chuy·ªÉn kho·∫£n - hi·ªÉn th·ªã QR code
        if (phuongThuc === "Chuy·ªÉn kho·∫£n") {
            processBankTransferOrder(userInfo.id, hoTen, dienThoai, diaChi);
            return;
        }
    });
}

/* ===============================
   X·ª¨ L√ù THANH TO√ÅN COD
================================ */
function processCODOrder(nguoiDung_id, hoTen, dienThoai, diaChi) {
    const btn = document.getElementById('checkoutBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.classList.add('loading');
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω ƒë∆°n h√†ng...';

    // T·∫°o ƒë∆°n h√†ng
    fetch("http://127.0.0.1:5000/api/don-hang", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
            nguoiDung_id: nguoiDung_id,
            diaChiGiaoHang: diaChi
        })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
        }

        const dhId = data.donHang_id;
        showToast("‚úÖ ƒê√£ t·∫°o ƒë∆°n h√†ng. ƒêang x·ª≠ l√Ω thanh to√°n...", "info");
        
        // Thanh to√°n COD
        return fetch("http://127.0.0.1:5000/api/thanh-toan/thanh-toan", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({
                donHang_id: dhId,
                phuongThuc: "COD"
            })
        });
    })
    .then(res => res.json())
    .then(data => {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.innerHTML = originalText;

        if (data.success) {
            showToast("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! B·∫°n s·∫Ω thanh to√°n khi nh·∫≠n h√†ng.", "success");
            localStorage.removeItem("gioHang");
            setTimeout(() => {
                window.location.href = "don-hang-cua-toi.html";
            }, 2000);
        } else {
            showToast(data.message || "Thanh to√°n th·∫•t b·∫°i", "error");
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.innerHTML = originalText;
        showToast("‚ùå L·ªói: " + err.message, "error");
        console.error("Order error:", err);
    });
}

/* ===============================
   X·ª¨ L√ù THANH TO√ÅN CHUY·ªÇN KHO·∫¢N
================================ */
function processBankTransferOrder(nguoiDung_id, hoTen, dienThoai, diaChi) {
    const btn = document.getElementById('checkoutBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.classList.add('loading');
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ƒêang t·∫°o ƒë∆°n h√†ng...';

    // T√≠nh t·ªïng ti·ªÅn
    const tongTienEl = document.getElementById("tongTien");
    const tongTien = parseInt(tongTienEl.textContent.replace(/[^\d]/g, '')) || 0;

    // T·∫°o ƒë∆°n h√†ng
    fetch("http://127.0.0.1:5000/api/don-hang", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
            nguoiDung_id: nguoiDung_id,
            hoTen: hoTen,
            dienThoai: dienThoai,
            diaChiGiaoHang: diaChi,
            khuyenMai_id: selectedKhuyenMai ? selectedKhuyenMai.id : null
        })
    })
    .then(res => res.json())
    .then(data => {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.innerHTML = originalText;

        if (!data.success) {
            throw new Error(data.message || "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
        }

        tempDonHangId = data.donHang_id;
        tempTongTien = tongTien;

        // Hi·ªÉn th·ªã modal QR code v·ªõi th√¥ng tin kh√°ch h√†ng
        showQRCodeModal(tongTien, data.donHang_id, hoTen, dienThoai, diaChi);
    })
    .catch(err => {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.innerHTML = originalText;
        showToast("‚ùå L·ªói: " + err.message, "error");
        console.error("Order error:", err);
    });
}

/* ===============================
   HI·ªÇN TH·ªä MODAL QR CODE
================================ */
function showQRCodeModal(tongTien, donHangId, hoTen, dienThoai, diaChi) {
    // Th√¥ng tin t√†i kho·∫£n t·ª´ QR code c·ªßa b·∫°n
    const accountHolder = "PH·∫†M TH√ÄNH ƒê·∫†T";
    const phoneNumber = "0984868340";
    const amount = tongTien;
    const content = `DonHang${donHangId}`;
    
    // C·∫≠p nh·∫≠t th√¥ng tin trong modal
    document.getElementById("accountHolder").textContent = accountHolder;
    document.getElementById("phoneNumber").textContent = phoneNumber;
    document.getElementById("paymentAmount").textContent = new Intl.NumberFormat('vi-VN').format(amount) + "ƒë";
    document.getElementById("paymentContent").textContent = content;
    
    // Hi·ªÉn th·ªã th√¥ng tin kh√°ch h√†ng trong modal (n·∫øu c·∫ßn)
    // C√≥ th·ªÉ th√™m section hi·ªÉn th·ªã th√¥ng tin giao h√†ng
    
    // Hi·ªÉn th·ªã QR code image (ƒë√£ c√≥ s·∫µn trong images/qr.jpg)
    const qrImage = document.getElementById("qrImage");
    if (qrImage) {
        qrImage.src = "images/qr.jpg";
        qrImage.style.display = "block";
    }
    
    // L∆∞u th√¥ng tin ƒë∆°n h√†ng v√†o bi·∫øn t·∫°m (n·∫øu ch∆∞a c√≥)
    if (!tempDonHangId) {
        tempDonHangId = donHangId;
        tempTongTien = tongTien;
    }
    
    // Hi·ªÉn th·ªã modal
    const modal = new bootstrap.Modal(document.getElementById("qrPaymentModal"));
    modal.show();
    
    // Reset n√∫t x√°c nh·∫≠n v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
    const confirmBtn = document.getElementById("confirmTransferBtn");
    if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fa fa-check"></i> ƒê√£ chuy·ªÉn kho·∫£n';
    }
}

/* ===============================
   COPY TO CLIPBOARD
================================ */
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast("‚úÖ ƒê√£ copy v√†o clipboard", "success");
    }).catch(() => {
        // Fallback cho tr√¨nh duy·ªát c≈©
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast("‚úÖ ƒê√£ copy", "success");
    });
}

/* ===============================
   COPY N·ªòI DUNG CHUY·ªÇN KHO·∫¢N
================================ */
function copyPaymentContent() {
    const content = document.getElementById("paymentContent").textContent;
    copyToClipboard(content);
}

/* ===============================
   ƒê√ìNG MODAL QR CODE
================================ */
function closeQRModal() {
    // Ki·ªÉm tra xem ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o ch∆∞a
    if (tempDonHangId) {
        // H·ªèi x√°c nh·∫≠n tr∆∞·ªõc khi ƒë√≥ng
        if (confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√≥ng?\n\nƒê∆°n h√†ng #" + tempDonHangId + " ƒë√£ ƒë∆∞·ª£c t·∫°o.\nB·∫°n c√≥ th·ªÉ thanh to√°n sau trong m·ª•c 'ƒê∆°n h√†ng c·ªßa t√¥i'.\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c ƒë√≥ng kh√¥ng?")) {
            const modal = bootstrap.Modal.getInstance(document.getElementById("qrPaymentModal"));
            if (modal) {
                modal.hide();
            }
            // Kh√¥ng reset bi·∫øn ƒë·ªÉ user c√≥ th·ªÉ quay l·∫°i thanh to√°n sau
            // tempDonHangId v√† tempTongTien s·∫Ω ƒë∆∞·ª£c reset khi thanh to√°n th√†nh c√¥ng
            
            showToast("üí° B·∫°n c√≥ th·ªÉ quay l·∫°i thanh to√°n ƒë∆°n h√†ng n√†y sau trong m·ª•c 'ƒê∆°n h√†ng c·ªßa t√¥i'", "info");
            
            // Reload gi·ªè h√†ng ƒë·ªÉ c·∫≠p nh·∫≠t (gi·ªè h√†ng ƒë√£ ƒë∆∞·ª£c x√≥a khi t·∫°o ƒë∆°n h√†ng)
            setTimeout(() => {
                loadCart();
            }, 1000);
        }
    } else {
        // N·∫øu ch∆∞a c√≥ ƒë∆°n h√†ng, ch·ªâ ƒë√≥ng modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("qrPaymentModal"));
        if (modal) {
            modal.hide();
        }
    }
}

/* ===============================
   X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN KHO·∫¢N
================================ */
function confirmBankTransfer(event) {
    if (!tempDonHangId) {
        showToast("Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.", "error");
        return;
    }

    // X√°c nh·∫≠n tr∆∞·ªõc khi g·ª≠i
    if (!confirm("B·∫°n ƒë√£ chuy·ªÉn kho·∫£n th√†nh c√¥ng?\n\nVui l√≤ng ƒë·∫£m b·∫£o:\n‚úì ƒê√£ chuy·ªÉn ƒë√∫ng s·ªë ti·ªÅn\n‚úì ƒê√£ nh·∫≠p ƒë√∫ng n·ªôi dung chuy·ªÉn kho·∫£n\n‚úì ƒê√£ qu√©t m√£ QR ho·∫∑c chuy·ªÉn kho·∫£n th·ªß c√¥ng\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn ƒë√£ ho√†n t·∫•t chuy·ªÉn kho·∫£n?")) {
        return;
    }

    const confirmBtn = event ? event.target : document.getElementById("confirmTransferBtn");
    const originalText = confirmBtn.innerHTML;
    
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

    // Ghi thanh to√°n v√†o database
    fetch("http://127.0.0.1:5000/api/thanh-toan/thanh-toan", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
            donHang_id: tempDonHangId,
            phuongThuc: "Chuy·ªÉn kho·∫£n"
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // ƒê√≥ng modal
            const modal = bootstrap.Modal.getInstance(document.getElementById("qrPaymentModal"));
            if (modal) {
                modal.hide();
            }
            
            showToast("‚úÖ ƒê√£ ghi nh·∫≠n thanh to√°n! ƒê∆°n h√†ng ƒëang ch·ªù x√°c nh·∫≠n t·ª´ admin.", "success");
            
            // X√≥a gi·ªè h√†ng v√† reset bi·∫øn
            localStorage.removeItem("gioHang");
            tempDonHangId = null;
            tempTongTien = 0;
            
            // Chuy·ªÉn ƒë·∫øn trang ƒë∆°n h√†ng sau 2 gi√¢y
            setTimeout(() => {
                window.location.href = "don-hang-cua-toi.html";
            }, 2000);
        } else {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText;
            showToast(data.message || "Kh√¥ng th·ªÉ ghi nh·∫≠n thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.", "error");
        }
    })
    .catch(err => {
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalText;
        showToast("‚ùå L·ªói k·∫øt n·ªëi: " + (err.message || "Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i"), "error");
        console.error("Payment error:", err);
    });
}

/* ===============================
   X·ª¨ L√ù KHI MODAL ƒê√ìNG
================================ */
document.addEventListener('DOMContentLoaded', function() {
    const qrModal = document.getElementById('qrPaymentModal');
    if (qrModal) {
        // X·ª≠ l√Ω khi modal b·ªã ƒë√≥ng (click ngo√†i, ESC, v.v.)
        qrModal.addEventListener('hidden.bs.modal', function() {
            // N·∫øu ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o nh∆∞ng ch∆∞a thanh to√°n
            if (tempDonHangId) {
                console.log("Modal ƒë√£ ƒë√≥ng. ƒê∆°n h√†ng #" + tempDonHangId + " ƒë√£ ƒë∆∞·ª£c t·∫°o v√† ch·ªù thanh to√°n.");
                // Kh√¥ng reset bi·∫øn ƒë·ªÉ user c√≥ th·ªÉ quay l·∫°i thanh to√°n sau
            }
        });
    }
});

/* ===============================
   LOAD BAN ƒê·∫¶U
================================ */
// ƒê·∫£m b·∫£o DOM ƒë√£ load xong
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, initializing cart...");
        loadCart();
        loadCustomerInfo();
    });
} else {
    // DOM ƒë√£ s·∫µn s√†ng
    console.log("DOM ready, initializing cart...");
    loadCart();
    loadCustomerInfo();
}

// ƒê·∫£m b·∫£o c√°c tr∆∞·ªùng lu√¥n c√≥ th·ªÉ ch·ªânh s·ª≠a
document.addEventListener('DOMContentLoaded', function() {
    const fields = ['hoTen', 'dienThoai', 'diaChi'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            // ƒê·∫£m b·∫£o kh√¥ng b·ªã disable
            field.disabled = false;
            field.readOnly = false;
            
            // Th√™m visual feedback khi focus
            field.addEventListener('focus', function() {
                this.style.borderColor = '#ff6b81';
                this.style.boxShadow = '0 0 0 4px rgba(255,107,129,0.15)';
            });
            
            // Remove focus style khi blur
            field.addEventListener('blur', function() {
                if (!this.classList.contains('is-invalid')) {
                    this.style.borderColor = '';
                    this.style.boxShadow = '';
                }
            });
        }
    });
});

// Real-time validation
document.getElementById("hoTen").addEventListener("blur", function() {
    if (this.value.trim().length >= 2) {
        this.classList.remove("is-invalid");
        this.classList.add("is-valid");
    } else {
        this.classList.remove("is-valid");
        this.classList.add("is-invalid");
    }
});

document.getElementById("dienThoai").addEventListener("blur", function() {
    const phonePattern = /^[0-9]{10,11}$/;
    if (phonePattern.test(this.value.trim())) {
        this.classList.remove("is-invalid");
        this.classList.add("is-valid");
    } else {
        this.classList.remove("is-valid");
        this.classList.add("is-invalid");
    }
});

document.getElementById("diaChi").addEventListener("blur", function() {
    if (this.value.trim().length >= 10) {
        this.classList.remove("is-invalid");
        this.classList.add("is-valid");
    } else {
        this.classList.remove("is-valid");
        this.classList.add("is-invalid");
    }
});

// ƒê·∫£m b·∫£o c√°c tr∆∞·ªùng lu√¥n c√≥ th·ªÉ ch·ªânh s·ª≠a - ki·ªÉm tra ƒë·ªãnh k·ª≥
setInterval(function() {
    const fields = ['hoTen', 'dienThoai', 'diaChi'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && field.disabled) {
            field.disabled = false;
        }
        if (field && field.readOnly) {
            field.readOnly = false;
        }
    });
}, 1000); // Ki·ªÉm tra m·ªói gi√¢y
</script>


</body>
</html>
