<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω khuy·∫øn m√£i | Admin BabyCutie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<header class="header">
    <div class="container header-wrap">
        <div class="logo" onclick="location='admin-dashboard.html'">
            <span>üõ† Qu·∫£n l√Ω khuy·∫øn m√£i</span>
        </div>
        <button class="btn-login" onclick="location='admin-dashboard.html'">‚Üê Dashboard</button>
    </div>
</header>

<section class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>üè∑Ô∏è Danh s√°ch khuy·∫øn m√£i</h3>
        <button class="btn btn-danger" onclick="openForm()">‚ûï Th√™m khuy·∫øn m√£i</button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover bg-white">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>M√£ KM</th>
                    <th>T√™n khuy·∫øn m√£i</th>
                    <th>Lo·∫°i</th>
                    <th>Gi√° tr·ªã</th>
                    <th>ƒê∆°n t·ªëi thi·ªÉu</th>
                    <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                    <th>Ng√†y k·∫øt th√∫c</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="khuyenMaiTable">
                <tr><td colspan="10" class="text-center">ƒêang t·∫£i...</td></tr>
            </tbody>
        </table>
    </div>
</section>

<!-- MODAL -->
<div class="modal fade" id="khuyenMaiModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Khuy·∫øn m√£i</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="khuyenMaiId">
                <div class="mb-2">
                    <label>T√™n khuy·∫øn m√£i *</label>
                    <input class="form-control" id="tenKhuyenMai" required>
                </div>
                <div class="mb-2">
                    <label>M√£ khuy·∫øn m√£i *</label>
                    <input class="form-control" id="maKhuyenMai" required>
                </div>
                <div class="mb-2">
                    <label>Lo·∫°i gi·∫£m gi√° *</label>
                    <select class="form-control" id="loaiGiamGia" required>
                        <option value="phan_tram">Ph·∫ßn trƒÉm (%)</option>
                        <option value="tien_mat">Ti·ªÅn m·∫∑t (ƒë)</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label>Gi√° tr·ªã gi·∫£m *</label>
                    <input type="number" class="form-control" id="giaTriGiam" required>
                </div>
                <div class="mb-2">
                    <label>Gi√° tr·ªã t·ªëi ƒëa (n·∫øu gi·∫£m %)</label>
                    <input type="number" class="form-control" id="giaTriToiDa">
                </div>
                <div class="mb-2">
                    <label>ƒê∆°n h√†ng t·ªëi thi·ªÉu</label>
                    <input type="number" class="form-control" id="donHangToiThieu">
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <label>Ng√†y b·∫Øt ƒë·∫ßu</label>
                        <input type="datetime-local" class="form-control" id="ngayBatDau">
                    </div>
                    <div class="col-md-6">
                        <label>Ng√†y k·∫øt th√∫c</label>
                        <input type="datetime-local" class="form-control" id="ngayKetThuc">
                    </div>
                </div>
                <div class="mb-2 mt-2">
                    <label>
                        <input type="checkbox" id="trangThai" checked> Ho·∫°t ƒë·ªông
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button class="btn btn-danger" onclick="saveKhuyenMai()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_URL = "http://127.0.0.1:5000/api/admin/khuyen-mai";
const modal = new bootstrap.Modal(document.getElementById("khuyenMaiModal"));

if (!localStorage.getItem("admin_token")) {
    window.location.href = "login-admin.html";
}

function loadKhuyenMai() {
    fetch(API_URL)
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById("khuyenMaiTable");
            tbody.innerHTML = "";
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center">Ch∆∞a c√≥ khuy·∫øn m√£i</td></tr>`;
                return;
            }
            data.forEach((km, i) => {
                const loai = km.loaiGiamGia === 'phan_tram' ? `${km.giaTriGiam}%` : `${new Intl.NumberFormat('vi-VN').format(km.giaTriGiam)}ƒë`;
                tbody.innerHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td><strong>${km.maKhuyenMai}</strong></td>
                        <td>${km.tenKhuyenMai}</td>
                        <td>${km.loaiGiamGia === 'phan_tram' ? 'Ph·∫ßn trƒÉm' : 'Ti·ªÅn m·∫∑t'}</td>
                        <td>${loai}</td>
                        <td>${km.donHangToiThieu ? new Intl.NumberFormat('vi-VN').format(km.donHangToiThieu) + 'ƒë' : '-'}</td>
                        <td>${km.ngayBatDau ? new Date(km.ngayBatDau).toLocaleDateString('vi-VN') : '-'}</td>
                        <td>${km.ngayKetThuc ? new Date(km.ngayKetThuc).toLocaleDateString('vi-VN') : '-'}</td>
                        <td>${km.trangThai ? '<span class="badge bg-success">Ho·∫°t ƒë·ªông</span>' : '<span class="badge bg-secondary">T·∫°m d·ª´ng</span>'}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editKhuyenMai(${km.id})">S·ª≠a</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteKhuyenMai(${km.id})">X√≥a</button>
                        </td>
                    </tr>
                `;
            });
        });
}

function openForm() {
    document.getElementById("khuyenMaiId").value = "";
    document.getElementById("tenKhuyenMai").value = "";
    document.getElementById("maKhuyenMai").value = "";
    document.getElementById("loaiGiamGia").value = "phan_tram";
    document.getElementById("giaTriGiam").value = "";
    document.getElementById("giaTriToiDa").value = "";
    document.getElementById("donHangToiThieu").value = "";
    document.getElementById("ngayBatDau").value = "";
    document.getElementById("ngayKetThuc").value = "";
    document.getElementById("trangThai").checked = true;
    modal.show();
}

function editKhuyenMai(id) {
    fetch(`${API_URL}`)
        .then(res => res.json())
        .then(data => {
            const km = data.find(x => x.id === id);
            if (!km) return;
            document.getElementById("khuyenMaiId").value = km.id;
            document.getElementById("tenKhuyenMai").value = km.tenKhuyenMai;
            document.getElementById("maKhuyenMai").value = km.maKhuyenMai;
            document.getElementById("loaiGiamGia").value = km.loaiGiamGia;
            document.getElementById("giaTriGiam").value = km.giaTriGiam;
            document.getElementById("giaTriToiDa").value = km.giaTriToiDa || "";
            document.getElementById("donHangToiThieu").value = km.donHangToiThieu || "";
            if (km.ngayBatDau) {
                document.getElementById("ngayBatDau").value = new Date(km.ngayBatDau).toISOString().slice(0, 16);
            }
            if (km.ngayKetThuc) {
                document.getElementById("ngayKetThuc").value = new Date(km.ngayKetThuc).toISOString().slice(0, 16);
            }
            document.getElementById("trangThai").checked = km.trangThai;
            modal.show();
        });
}

function saveKhuyenMai() {
    const id = document.getElementById("khuyenMaiId").value;
    const data = {
        tenKhuyenMai: document.getElementById("tenKhuyenMai").value,
        maKhuyenMai: document.getElementById("maKhuyenMai").value,
        loaiGiamGia: document.getElementById("loaiGiamGia").value,
        giaTriGiam: parseFloat(document.getElementById("giaTriGiam").value),
        giaTriToiDa: document.getElementById("giaTriToiDa").value ? parseFloat(document.getElementById("giaTriToiDa").value) : null,
        donHangToiThieu: document.getElementById("donHangToiThieu").value ? parseFloat(document.getElementById("donHangToiThieu").value) : null,
        ngayBatDau: document.getElementById("ngayBatDau").value || null,
        ngayKetThuc: document.getElementById("ngayKetThuc").value || null,
        trangThai: document.getElementById("trangThai").checked ? 1 : 0
    };

    const url = id ? `${API_URL}/${id}` : API_URL;
    const method = id ? "PUT" : "POST";

    fetch(url, {
        method: method,
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            alert(id ? "C·∫≠p nh·∫≠t th√†nh c√¥ng" : "Th√™m th√†nh c√¥ng");
            modal.hide();
            loadKhuyenMai();
        } else {
            alert(result.message || "C√≥ l·ªói x·∫£y ra");
        }
    });
}

function deleteKhuyenMai(id) {
    if (!confirm("X√≥a khuy·∫øn m√£i n√†y?")) return;
    fetch(`${API_URL}/${id}`, {method: "DELETE"})
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                alert("ƒê√£ x√≥a");
                loadKhuyenMai();
            }
        });
}

loadKhuyenMai();
</script>

</body>
</html>

