<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi tiáº¿t sáº£n pháº©m | BabyCutie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<header class="header">
    <div class="container header-wrap">
        <div class="logo" onclick="location='index.html'"><img src="images/logo2.jpg"><span>BabyCutie</span></div>
        <button class="btn-login" onclick="location='thuc-don.html'">â† Thá»±c Ä‘Æ¡n</button>
    </div>
</header>
<section class="container mt-4">
    <div id="productDetail" class="row">
        <div class="col-md-6">
            <img id="productImage" src="" class="img-fluid" style="max-height: 400px; object-fit: cover;">
        </div>
        <div class="col-md-6">
            <h2 id="productName"></h2>
            <p class="text-muted" id="productMoTa"></p>
            <h3 class="text-danger" id="productPrice"></h3>
            <p><strong>Äá»™ tuá»•i:</strong> <span id="productDoTuoi"></span></p>
            <div class="mb-3">
                <strong>Dinh dÆ°á»¡ng:</strong>
                <span>ğŸ’ª Protein: <span id="productProtein"></span>g</span> |
                <span>ğŸš Carb: <span id="productCarb"></span>g</span> |
                <span>ğŸ¥‘ Fat: <span id="productChatBeo"></span>g</span>
            </div>
            <button class="btn btn-danger btn-lg" onclick="addToCart()">ğŸ›’ ThÃªm vÃ o giá»</button>
        </div>
    </div>

    <hr class="my-5">

    <!-- ÄÃNH GIÃ -->
    <div class="row">
        <div class="col-md-6">
            <h4>â­ ÄÃ¡nh giÃ¡ sáº£n pháº©m</h4>
            <div id="ratingStats" class="mb-3"></div>
            <div id="ratingForm" style="display: none;">
                <h5>Viáº¿t Ä‘Ã¡nh giÃ¡</h5>
                <div class="mb-2">
                    <label>Sá»‘ sao *</label>
                    <select class="form-control" id="soSao">
                        <option value="5">â­â­â­â­â­ (5 sao)</option>
                        <option value="4">â­â­â­â­ (4 sao)</option>
                        <option value="3">â­â­â­ (3 sao)</option>
                        <option value="2">â­â­ (2 sao)</option>
                        <option value="1">â­ (1 sao)</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label>Ná»™i dung</label>
                    <textarea class="form-control" id="noiDungDanhGia" rows="3"></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitDanhGia()">Gá»­i Ä‘Ã¡nh giÃ¡</button>
            </div>
            <div id="loginPrompt" class="alert alert-info">
                <a href="login-khach.html">ÄÄƒng nháº­p</a> Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ sáº£n pháº©m
            </div>
        </div>
        <div class="col-md-6">
            <h5>ÄÃ¡nh giÃ¡ tá»« khÃ¡ch hÃ ng</h5>
            <div id="danhGiaList"></div>
        </div>
    </div>
</section>
<script>
const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get('id');
const token = localStorage.getItem("token");
const userInfo = JSON.parse(localStorage.getItem("user_info") || '{}');

if (!productId) {
    alert("KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m");
    window.location.href = "thuc-don.html";
}

// Load chi tiáº¿t sáº£n pháº©m
fetch(`http://127.0.0.1:5000/api/thuc-don/${productId}`)
    .then(r => r.json())
    .then(data => {
        document.getElementById("productName").textContent = data.tenSanPham;
        document.getElementById("productMoTa").textContent = data.moTa || '';
        document.getElementById("productPrice").textContent = new Intl.NumberFormat('vi-VN').format(data.gia) + 'Ä‘';
        document.getElementById("productDoTuoi").textContent = data.doTuoi || '-';
        document.getElementById("productProtein").textContent = data.protein || 0;
        document.getElementById("productCarb").textContent = data.carb || 0;
        document.getElementById("productChatBeo").textContent = data.chatBeo || 0;
        document.getElementById("productImage").src = `http://127.0.0.1:5000/images/${data.hinhAnh || 'default.jpg'}`;
    });

// Load Ä‘Ã¡nh giÃ¡
function loadDanhGia() {
    fetch(`http://127.0.0.1:5000/api/danh-gia/san-pham/${productId}`)
        .then(r => r.json())
        .then(data => {
            // Thá»‘ng kÃª
            document.getElementById("ratingStats").innerHTML = `
                <p><strong>Trung bÃ¬nh:</strong> ${data.thongKe.trungBinhSao} â­ (${data.thongKe.tongSoDanhGia} Ä‘Ã¡nh giÃ¡)</p>
            `;

            // Danh sÃ¡ch Ä‘Ã¡nh giÃ¡
            const list = document.getElementById("danhGiaList");
            if (data.danhGia.length === 0) {
                list.innerHTML = '<p class="text-muted">ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡ nÃ o</p>';
            } else {
                list.innerHTML = data.danhGia.map(dg => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <strong>${dg.hoTen}</strong> ${'â­'.repeat(dg.soSao)}
                            <p class="mb-0">${dg.noiDung || ''}</p>
                            <small class="text-muted">${new Date(dg.ngayDanhGia).toLocaleDateString('vi-VN')}</small>
                        </div>
                    </div>
                `).join('');
            }

            // Hiá»ƒn thá»‹ form Ä‘Ã¡nh giÃ¡
            if (token) {
                document.getElementById("ratingForm").style.display = "block";
                document.getElementById("loginPrompt").style.display = "none";
            } else {
                document.getElementById("ratingForm").style.display = "none";
                document.getElementById("loginPrompt").style.display = "block";
            }
        });
}

function submitDanhGia() {
    if (!token) {
        alert("Vui lÃ²ng Ä‘Äƒng nháº­p");
        window.location.href = "login-khach.html";
        return;
    }

    const data = {
        sanPham_id: parseInt(productId),
        soSao: parseInt(document.getElementById("soSao").value),
        noiDung: document.getElementById("noiDungDanhGia").value
    };

    fetch("http://127.0.0.1:5000/api/danh-gia", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            alert("Cáº£m Æ¡n báº¡n Ä‘Ã£ Ä‘Ã¡nh giÃ¡!");
            document.getElementById("noiDungDanhGia").value = "";
            loadDanhGia();
        } else {
            alert(result.message || "CÃ³ lá»—i xáº£y ra");
        }
    });
}

function addToCart() {
    if (!token) {
        alert("Vui lÃ²ng Ä‘Äƒng nháº­p");
        window.location.href = "login-khach.html";
        return;
    }
    fetch("http://127.0.0.1:5000/api/gio-hang", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ sanPham_id: parseInt(productId), soLuong: 1 })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert("âœ… ÄÃ£ thÃªm vÃ o giá» hÃ ng!");
        }
    });
}

loadDanhGia();
</script>
</body>
</html>

