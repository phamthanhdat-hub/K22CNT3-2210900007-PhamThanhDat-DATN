<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi ti·∫øt s·∫£n ph·∫©m | BabyCutie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<header class="header">
    <div class="container header-wrap">
        <div class="logo" onclick="location='index.html'"><img src="images/logo2.jpg"><span>BabyCutie</span></div>
        <button class="btn-login" onclick="location='thuc-don.html'">‚Üê Th·ª±c ƒë∆°n</button>
    </div>
</header>
<section class="container mt-4">
    <div id="productDetail" class="row">
        <div class="col-md-6">
            <img id="productImage" src="" class="img-fluid" style="max-height: 400px; object-fit: cover;">
        </div>
        <div class="col-md-6">
            <h2 id="productName"></h2>
            <p class="text-muted" id="productMoTa"></p>
            
            <!-- Ch·ªçn size -->
            <div class="mb-3">
                <label class="form-label"><strong>üìè Ch·ªçn k√≠ch th∆∞·ªõc:</strong></label>
                <div class="btn-group" role="group" id="sizeSelector">
                    <input type="radio" class="btn-check" name="size" id="sizeVua" value="vua" checked>
                    <label class="btn btn-outline-primary" for="sizeVua">V·ª´a</label>
                    
                    <input type="radio" class="btn-check" name="size" id="sizeLon" value="lon">
                    <label class="btn btn-outline-primary" for="sizeLon">L·ªõn</label>
                    
                    <input type="radio" class="btn-check" name="size" id="sizeDai" value="dai">
                    <label class="btn btn-outline-primary" for="sizeDai">ƒê·∫°i</label>
                </div>
                <div id="sizePriceInfo" class="mt-2">
                    <small class="text-muted">Gi√°: <span id="selectedSizePrice" class="fw-bold text-danger"></span></small>
                </div>
            </div>
            
            <h3 class="text-danger" id="productPrice"></h3>
            <p><strong>ƒê·ªô tu·ªïi:</strong> <span id="productDoTuoi"></span></p>
            <div class="mb-3">
                <strong>Dinh d∆∞·ª°ng:</strong>
                <span>üí™ Protein: <span id="productProtein"></span>g</span> |
                <span>üçö Carb: <span id="productCarb"></span>g</span> |
                <span>ü•ë Fat: <span id="productChatBeo"></span>g</span>
            </div>
            <button class="btn btn-danger btn-lg" id="addToCartBtn" onclick="addToCart()">üõí Th√™m v√†o gi·ªè</button>
            <div id="cartQuantityInfo" class="mt-2" style="display: none;">
                <small class="text-success">
                    <i class="fa fa-check-circle"></i> 
                    ƒê√£ c√≥ <strong id="currentQuantity">0</strong> s·∫£n ph·∫©m trong gi·ªè h√†ng
                </small>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <!-- ƒê√ÅNH GI√Å -->
    <div class="row">
        <div class="col-md-6">
            <h4>‚≠ê ƒê√°nh gi√° s·∫£n ph·∫©m</h4>
            <div id="ratingStats" class="mb-3"></div>
            <div id="ratingForm" style="display: none;">
                <h5>Vi·∫øt ƒë√°nh gi√°</h5>
                <div class="mb-2">
                    <label>S·ªë sao *</label>
                    <select class="form-control" id="soSao">
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 sao)</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 sao)</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê (3 sao)</option>
                        <option value="2">‚≠ê‚≠ê (2 sao)</option>
                        <option value="1">‚≠ê (1 sao)</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label>N·ªôi dung</label>
                    <textarea class="form-control" id="noiDungDanhGia" rows="3"></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitDanhGia()">G·ª≠i ƒë√°nh gi√°</button>
            </div>
            <div id="loginPrompt" class="alert alert-info">
                <a href="login-khach.html">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ ƒë√°nh gi√° s·∫£n ph·∫©m
            </div>
        </div>
        <div class="col-md-6">
            <h5>ƒê√°nh gi√° t·ª´ kh√°ch h√†ng</h5>
            <div id="danhGiaList"></div>
        </div>
    </div>
</section>
<script>
const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get('id');
const token = localStorage.getItem("token");
const userInfo = JSON.parse(localStorage.getItem("user_info") || '{}');

if (!productId) {
    alert("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m");
    window.location.href = "thuc-don.html";
}

// L∆∞u th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ d√πng cho size
let productData = null;

// Load chi ti·∫øt s·∫£n ph·∫©m
fetch(`http://127.0.0.1:5000/api/thuc-don/${productId}`)
    .then(r => r.json())
    .then(data => {
        productData = data;
        document.getElementById("productName").textContent = data.tenSanPham;
        document.getElementById("productMoTa").textContent = data.moTa || '';
        document.getElementById("productDoTuoi").textContent = data.doTuoi || '-';
        document.getElementById("productProtein").textContent = data.protein || 0;
        document.getElementById("productCarb").textContent = data.carb || 0;
        document.getElementById("productChatBeo").textContent = data.chatBeo || 0;
        document.getElementById("productImage").src = `http://127.0.0.1:5000/images/${data.hinhAnh || 'default.jpg'}`;
        
        // Hi·ªÉn th·ªã gi√° v√† size
        updateSizeDisplay();
        
        // Th√™m event listener cho size selector
        document.querySelectorAll('input[name="size"]').forEach(radio => {
            radio.addEventListener('change', updateSizeDisplay);
        });
    });

// Load ƒë√°nh gi√°
function loadDanhGia() {
    fetch(`http://127.0.0.1:5000/api/danh-gia/san-pham/${productId}`)
        .then(r => r.json())
        .then(data => {
            // Th·ªëng k√™
            document.getElementById("ratingStats").innerHTML = `
                <p><strong>Trung b√¨nh:</strong> ${data.thongKe.trungBinhSao} ‚≠ê (${data.thongKe.tongSoDanhGia} ƒë√°nh gi√°)</p>
            `;

            // Danh s√°ch ƒë√°nh gi√°
            const list = document.getElementById("danhGiaList");
            if (data.danhGia.length === 0) {
                list.innerHTML = '<p class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</p>';
            } else {
                list.innerHTML = data.danhGia.map(dg => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <strong>${dg.hoTen}</strong> ${'‚≠ê'.repeat(dg.soSao)}
                            <p class="mb-0">${dg.noiDung || ''}</p>
                            <small class="text-muted">${new Date(dg.ngayDanhGia).toLocaleDateString('vi-VN')}</small>
                        </div>
                    </div>
                `).join('');
            }

            // Hi·ªÉn th·ªã form ƒë√°nh gi√°
            if (token) {
                document.getElementById("ratingForm").style.display = "block";
                document.getElementById("loginPrompt").style.display = "none";
            } else {
                document.getElementById("ratingForm").style.display = "none";
                document.getElementById("loginPrompt").style.display = "block";
            }
        });
}

function submitDanhGia() {
    if (!token) {
        alert("Vui l√≤ng ƒëƒÉng nh·∫≠p");
        window.location.href = "login-khach.html";
        return;
    }

    const data = {
        sanPham_id: parseInt(productId),
        soSao: parseInt(document.getElementById("soSao").value),
        noiDung: document.getElementById("noiDungDanhGia").value
    };

    fetch("http://127.0.0.1:5000/api/danh-gia", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            alert("C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!");
            document.getElementById("noiDungDanhGia").value = "";
            loadDanhGia();
        } else {
            alert(result.message || "C√≥ l·ªói x·∫£y ra");
        }
    });
}

// C·∫≠p nh·∫≠t hi·ªÉn th·ªã gi√° theo size
function updateSizeDisplay() {
    if (!productData) return;
    
    const selectedSize = document.querySelector('input[name="size"]:checked').value;
    let price = productData.gia || 0;
    
    // ·∫®n/hi·ªán c√°c size kh√¥ng c√≥
    const sizeVua = document.getElementById('sizeVua');
    const sizeLon = document.getElementById('sizeLon');
    const sizeDai = document.getElementById('sizeDai');
    
    if (productData.giaVua) {
        sizeVua.parentElement.style.display = 'inline-block';
        if (selectedSize === 'vua') price = productData.giaVua;
    } else {
        sizeVua.parentElement.style.display = 'none';
    }
    
    if (productData.giaLon) {
        sizeLon.parentElement.style.display = 'inline-block';
        if (selectedSize === 'lon') price = productData.giaLon;
    } else {
        sizeLon.parentElement.style.display = 'none';
    }
    
    if (productData.giaDai) {
        sizeDai.parentElement.style.display = 'inline-block';
        if (selectedSize === 'dai') price = productData.giaDai;
    } else {
        sizeDai.parentElement.style.display = 'none';
    }
    
    // C·∫≠p nh·∫≠t gi√° hi·ªÉn th·ªã
    document.getElementById("productPrice").textContent = new Intl.NumberFormat('vi-VN').format(price) + 'ƒë';
    document.getElementById("selectedSizePrice").textContent = new Intl.NumberFormat('vi-VN').format(price) + 'ƒë';
}

function addToCart() {
    if (!token) {
        alert("Vui l√≤ng ƒëƒÉng nh·∫≠p");
        window.location.href = "login-khach.html";
        return;
    }

    const btn = document.getElementById("addToCartBtn");
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ƒêang th√™m...';

    // L·∫•y size ƒë√£ ch·ªçn
    const selectedSize = document.querySelector('input[name="size"]:checked').value;

    fetch("http://127.0.0.1:5000/api/gio-hang", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ 
            sanPham_id: parseInt(productId), 
            soLuong: 1,
            size: selectedSize
        })
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        
        if (data.success) {
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng hi·ªÉn th·ªã
            checkCartQuantity();
            // Toast notification
            showToast("‚úÖ ƒê√£ th√™m v√†o gi·ªè h√†ng!", "success");
        } else {
            btn.innerHTML = originalText;
            showToast("L·ªói: " + (data.message || "Kh√¥ng th·ªÉ th√™m v√†o gi·ªè"), "error");
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showToast("L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.", "error");
        console.error("Error:", err);
    });
}

// Ki·ªÉm tra s·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong gi·ªè
function checkCartQuantity() {
    if (!token) return;

    fetch("http://127.0.0.1:5000/api/gio-hang", {
        headers: {"Authorization": "Bearer " + token}
    })
    .then(res => res.json())
    .then(cartItems => {
        const item = cartItems.find(i => i.sanPham_id === parseInt(productId));
        const quantityInfo = document.getElementById("cartQuantityInfo");
        const currentQuantity = document.getElementById("currentQuantity");
        const btn = document.getElementById("addToCartBtn");

        if (item && item.soLuong > 0) {
            currentQuantity.textContent = item.soLuong;
            quantityInfo.style.display = "block";
            btn.innerHTML = `üõí ƒê√£ th√™m (${item.soLuong})`;
            btn.style.background = "linear-gradient(135deg, #28a745, #20c997)";
        } else {
            quantityInfo.style.display = "none";
            btn.innerHTML = "üõí Th√™m v√†o gi·ªè";
            btn.style.background = "";
        }
    })
    .catch(err => console.error("Error:", err));
}

// Toast notification
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type} show`;
    toast.innerHTML = `
        <i class="fa ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
    }, 3000);
}

loadDanhGia();
</script>
</body>
</html>

