<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý giỏ hàng | Admin BabyCutie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .cart-item-row:hover {
            background: rgba(255,107,129,0.05);
        }
        .btn-action {
            padding: 5px 12px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fa fa-shopping-cart"></i> Quản lý giỏ hàng</h2>
            <div>
                <a href="admin-dashboard.html" class="btn btn-secondary">
                    <i class="fa fa-arrow-left"></i> Về Dashboard
                </a>
            </div>
        </div>

        <!-- Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Tìm kiếm theo tên khách hàng</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="Nhập tên khách hàng...">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Tìm kiếm theo sản phẩm</label>
                        <input type="text" id="searchProductInput" class="form-control" placeholder="Nhập tên sản phẩm...">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="loadGioHang()">
                            <i class="fa fa-search"></i> Tìm kiếm
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>ID</th>
                                <th>Khách hàng</th>
                                <th>Sản phẩm</th>
                                <th>Hình ảnh</th>
                                <th>Giá</th>
                                <th>Số lượng</th>
                                <th>Thành tiền</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="gioHangTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <i class="fa fa-spinner fa-spin"></i> Đang tải...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edit Quantity -->
    <div class="modal fade" id="editQuantityModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cập nhật số lượng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Số lượng</label>
                        <input type="number" id="editQuantityInput" class="form-control" min="1" value="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveQuantity()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "http://127.0.0.1:5000/api/admin/gio-hang";
        const token = localStorage.getItem("admin_token");
        let currentEditId = null;
        let allGioHang = [];

        if (!token) {
            alert("Vui lòng đăng nhập");
            window.location.href = "login-admin.html";
        }

        // Load giỏ hàng
        function loadGioHang() {
            fetch(API_URL, {
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success === false) {
                    alert(data.message);
                    return;
                }

                allGioHang = data;
                
                // Filter
                const searchName = document.getElementById("searchInput").value.toLowerCase();
                const searchProduct = document.getElementById("searchProductInput").value.toLowerCase();
                
                let filtered = data;
                if (searchName) {
                    filtered = filtered.filter(item => 
                        item.hoTen.toLowerCase().includes(searchName)
                    );
                }
                if (searchProduct) {
                    filtered = filtered.filter(item => 
                        item.tenSanPham.toLowerCase().includes(searchProduct)
                    );
                }

                renderTable(filtered);
            })
            .catch(err => {
                console.error("Error:", err);
                document.getElementById("gioHangTableBody").innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger">
                            <i class="fa fa-exclamation-triangle"></i> Lỗi kết nối
                        </td>
                    </tr>
                `;
            });
        }

        // Render table
        function renderTable(data) {
            const tbody = document.getElementById("gioHangTableBody");
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="fa fa-shopping-cart"></i> Không có dữ liệu
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map(item => {
                const thanhTien = item.gia * item.soLuong;
                return `
                    <tr class="cart-item-row">
                        <td>${item.id}</td>
                        <td>
                            <strong>${item.hoTen}</strong><br>
                            <small class="text-muted">${item.email}</small><br>
                            <small class="text-muted">${item.dienThoai}</small>
                        </td>
                        <td>${item.tenSanPham}</td>
                        <td>
                            <img src="http://127.0.0.1:5000/images/${item.hinhAnh}" 
                                 alt="${item.tenSanPham}" 
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">
                        </td>
                        <td>${item.gia.toLocaleString()}₫</td>
                        <td>
                            <strong>${item.soLuong}</strong>
                        </td>
                        <td><strong class="text-primary">${thanhTien.toLocaleString()}₫</strong></td>
                        <td>
                            <button class="btn btn-sm btn-warning btn-action" onclick="openEditModal(${item.id}, ${item.soLuong})">
                                <i class="fa fa-edit"></i> Sửa
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteItem(${item.id})">
                                <i class="fa fa-trash"></i> Xóa
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Open edit modal
        function openEditModal(id, soLuong) {
            currentEditId = id;
            document.getElementById("editQuantityInput").value = soLuong;
            const modal = new bootstrap.Modal(document.getElementById("editQuantityModal"));
            modal.show();
        }

        // Save quantity
        function saveQuantity() {
            const soLuong = parseInt(document.getElementById("editQuantityInput").value);
            
            if (soLuong <= 0) {
                alert("Số lượng phải lớn hơn 0");
                return;
            }

            fetch(`${API_URL}/${currentEditId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ soLuong: soLuong })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("✅ Cập nhật thành công");
                    const modal = bootstrap.Modal.getInstance(document.getElementById("editQuantityModal"));
                    modal.hide();
                    loadGioHang();
                } else {
                    alert("Lỗi: " + (data.message || "Không thể cập nhật"));
                }
            })
            .catch(err => {
                alert("Lỗi kết nối: " + err.message);
            });
        }

        // Delete item
        function deleteItem(id) {
            if (!confirm("Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?")) {
                return;
            }

            fetch(`${API_URL}/${id}`, {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("✅ Đã xóa thành công");
                    loadGioHang();
                } else {
                    alert("Lỗi: " + (data.message || "Không thể xóa"));
                }
            })
            .catch(err => {
                alert("Lỗi kết nối: " + err.message);
            });
        }

        // Search on Enter
        document.getElementById("searchInput").addEventListener("keypress", function(e) {
            if (e.key === "Enter") loadGioHang();
        });
        document.getElementById("searchProductInput").addEventListener("keypress", function(e) {
            if (e.key === "Enter") loadGioHang();
        });

        // Load on page load
        loadGioHang();
    </script>
</body>
</html>

