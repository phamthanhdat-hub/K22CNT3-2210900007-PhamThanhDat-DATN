<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>BabyCutie ‚Äì Ch√°o dinh d∆∞·ª°ng cho b√©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/thuc-don.css">
</head>
<body>

<!-- ================= HEADER ================= -->
<header class="header">
    <div class="container header-wrap">

        <!-- LOGO -->
        <div class="logo" onclick="window.location='index.html'">
            <img src="images/logo2.jpg" alt="BabyCutie">
            <span>BabyCutie</span>
        </div>

        <!-- SEARCH -->
        <div class="search">
            <i class="fa fa-search"></i>
            <input type="text" placeholder="T√¨m m√≥n ƒÉn cho b√©...">
        </div>

        <!-- MENU -->
        <nav class="main-menu">
            <a href="index.html">Trang ch·ªß</a>
            <a href="thuc-don.html" class="active">Th·ª±c ƒë∆°n</a>
            <a href="tin-tuc.html">Tin t·ª©c</a>
            <a href="lien-he.html">Li√™n h·ªá</a>
        </nav>

        <!-- CART -->
        <div class="cart-icon" onclick="window.location='gio-hang.html'">
            <i class="fa-solid fa-cart-shopping"></i>
            <span class="cart-count" id="cartCount">0</span>
        </div>


    </div>
</header>
<!-- ================= MAIN ================= -->
<section class="menu-page">
    <div class="container">

        <!-- üîΩ C·∫§U TR√öC ROW CHU·∫®N CHO JS -->
        <div class="row">

            <!-- ================= FILTER (C·ªòT TR√ÅI) ================= -->
            <aside class="col-md-3 filter-box">
                <h5>‚ò∞ B·ªô l·ªçc</h5>

                <div class="filter-group">
                    <h6>Danh m·ª•c</h6>
                    <label><input type="checkbox" checked> Ch√°o Th·ªãt</label>
                    <label><input type="checkbox"> Ch√°o C√°</label>
                    <label><input type="checkbox"> Ch√°o H·∫°t & Ng≈© C·ªëc</label>
                </div>

                <div class="filter-group">
                    <h6>ƒê·ªô tu·ªïi ph√π h·ª£p</h6>
                    <label><input type="radio" name="age" value="6-12"> 6 ‚Äì 12 th√°ng</label>
                    <label><input type="radio" name="age" value="1-3"> 1 ‚Äì 3 tu·ªïi</label>
                </div>

                <div class="filter-group">
                    <h6>Kho·∫£ng gi√°</h6>
                    <label><input type="radio" name="gia"> D∆∞·ªõi 30.000ƒë</label>
                    <label><input type="radio" name="gia"> 30.000ƒë ‚Äì 50.000ƒë</label>
                    <label><input type="radio" name="gia"> Tr√™n 50.000ƒë</label>
                </div>

                <div class="combo-box">
                    <p><b>Combo ti·∫øt ki·ªám</b></p>
                    <p>Gi·∫£m 15% ƒë∆°n ƒë·∫ßu ti√™n</p>
                    <button class="btn-primary">Xem ngay</button>
                </div>
            </aside>

            <!-- ================= PRODUCT LIST (C·ªòT PH·∫¢I) ================= -->
            <main class="col-md-9">

                <!-- TITLE -->
                <div class="menu-head">
                    <div>
                        <h3>Th·ª±c ƒë∆°n ch√°o dinh d∆∞·ª°ng</h3>
                        <p>H∆∞∆°ng v·ªã t·ª± nhi√™n, tr·ªçn v·∫πn y√™u th∆∞∆°ng</p>
                    </div>
                    <select>
                        <option>Ph·ªï bi·∫øn nh·∫•t</option>
                        <option>Gi√° th·∫•p ‚Üí cao</option>
                        <option>Gi√° cao ‚Üí th·∫•p</option>
                    </select>
                </div>

                <!-- üîΩ JS S·∫º RENDER S·∫¢N PH·∫®M ·ªû ƒê√ÇY -->
                <div class="row g-4">
                    <!-- s·∫£n ph·∫©m t·ª´ API -->
                </div>

            </main>
        </div>
    </div>
</section>

<!-- ================= JS ================= -->

<script>
const API_URL = "http://127.0.0.1:5000/api/thuc-don";

let danhSachSanPham = [];

/* ===============================
   LOAD S·∫¢N PH·∫®M T·ª™ API
================================ */
function taiSanPham(thamSo = "") {
    let url = API_URL + thamSo;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            danhSachSanPham = data;
            hienThiSanPham(data);
        })
        .catch(err => {
            console.error(err);
            alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi server");
        });
}

/* ===============================
   HI·ªÇN TH·ªä S·∫¢N PH·∫®M (FULL TH√îNG TIN)
================================ */
function hienThiSanPham(ds) {
    const khuVuc = document.querySelector(".col-md-9 .row");
    let html = "";

    if (!ds || ds.length === 0) {
        khuVuc.innerHTML = "<p>Kh√¥ng c√≥ s·∫£n ph·∫©m ph√π h·ª£p</p>";
        return;
    }

    ds.forEach(sp => {
        html += `
        <div class="col-md-4 mb-4">
            <div class="product-card">

                <img 
                    src="http://127.0.0.1:5000/images/${sp.hinhAnh}" 
                    
                >

                <h5>${sp.tenSanPham}</h5>
                <p class="price">${Number(sp.gia).toLocaleString()}ƒë</p>

                <p class="desc">${sp.moTa || ""}</p>

                <div class="nutrition">
                    <span>üí™ Protein <b>${sp.protein || 0}g</b></span>
                    <span>üçö Carb <b>${sp.carb || 0}g</b></span>
                    <span>ü•ë Fat <b>${sp.chatBeo || 0}g</b></span>
                </div>

                <small class="age">üë∂ ƒê·ªô tu·ªïi: ${sp.doTuoi || "6‚Äì24 th√°ng"}</small>

                <button class="btn-add" onclick="themVaoGio(${sp.id})">
                    üõí Th√™m v√†o gi·ªè
                </button>

            </div>
        </div>
        `;
    });

    khuVuc.innerHTML = html;
}

/* ===============================
   T√åM KI·∫æM
================================ */
document.querySelector(".search-box input")?.addEventListener("input", function () {
    const tuKhoa = this.value.toLowerCase();

    const ketQua = danhSachSanPham.filter(sp =>
        sp.tenSanPham.toLowerCase().includes(tuKhoa)
    );

    hienThiSanPham(ketQua);
});

/* ===============================
   L·ªåC THEO ƒê·ªò TU·ªîI
================================ */
document.querySelectorAll("input[name='age']").forEach(radio => {
    radio.addEventListener("change", function () {
        taiSanPham(`?doTuoi=${this.value}`);
    });
});

/* ===============================
   L·ªåC THEO GI√Å
================================ */
document.querySelectorAll("input[name='gia']").forEach((radio, index) => {
    radio.addEventListener("change", function () {
        let ketQua = [];

        if (index === 0) {
            ketQua = danhSachSanPham.filter(sp => sp.gia < 30000);
        } else if (index === 1) {
            ketQua = danhSachSanPham.filter(sp => sp.gia >= 30000 && sp.gia <= 50000);
        } else {
            ketQua = danhSachSanPham.filter(sp => sp.gia > 50000);
        }

        hienThiSanPham(ketQua);
    });
});

/* ===============================
   S·∫ÆP X·∫æP
================================ */
document.querySelector("select")?.addEventListener("change", function () {
    let ds = [...danhSachSanPham];

    if (this.value.includes("th·∫•p")) {
        ds.sort((a, b) => a.gia - b.gia);
    } else if (this.value.includes("cao")) {
        ds.sort((a, b) => b.gia - a.gia);
    }

    hienThiSanPham(ds);
});

/* ===============================
   GI·ªé H√ÄNG (LOCAL STORAGE)
================================ */
function themVaoGio(id) {
    let gioHang = JSON.parse(localStorage.getItem("gioHang")) || [];

    const sanPham = danhSachSanPham.find(sp => sp.id === id);
    if (!sanPham) return;

    const tonTai = gioHang.find(sp => sp.id === id);

    if (tonTai) {
        tonTai.soLuong += 1;
    } else {
        gioHang.push({
            id: sanPham.id,
            tenSanPham: sanPham.tenSanPham,
            gia: sanPham.gia,
            hinhAnh: sanPham.hinhAnh,
            soLuong: 1
        });
    }

    localStorage.setItem("gioHang", JSON.stringify(gioHang));
    alert("‚úÖ ƒê√£ th√™m v√†o gi·ªè h√†ng");
}

/* ===============================
   X·ª¨ L√ù SEARCH PARAMETER T·ª™ URL
================================ */
function handleSearchFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const searchKeyword = urlParams.get('search');
    
    if (searchKeyword) {
        // ƒê·∫∑t gi√° tr·ªã v√†o input search
        const searchInput = document.querySelector('.search input');
        if (searchInput) {
            searchInput.value = searchKeyword;
        }
        
        // Load s·∫£n ph·∫©m v√† filter
        taiSanPham();
        
        // Sau khi load xong, filter theo keyword
        setTimeout(() => {
            const keyword = searchKeyword.toLowerCase();
            const ketQua = danhSachSanPham.filter(sp => 
                sp.tenSanPham.toLowerCase().includes(keyword) ||
                (sp.moTa && sp.moTa.toLowerCase().includes(keyword))
            );
            hienThiSanPham(ketQua);
            
            // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ k·∫øt qu·∫£
            if (ketQua.length === 0) {
                const khuVuc = document.querySelector(".col-md-9 .row");
                khuVuc.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fa fa-search" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
                        <h4>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</h4>
                        <p class="text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ph√π h·ª£p v·ªõi t·ª´ kh√≥a "<strong>${searchKeyword}</strong>"</p>
                        <button class="btn btn-primary mt-3" onclick="window.location='thuc-don.html'">
                            Xem t·∫•t c·∫£ s·∫£n ph·∫©m
                        </button>
                    </div>
                `;
            }
        }, 100);
    } else {
        taiSanPham();
    }
}

/* ===============================
   LOAD BAN ƒê·∫¶U
================================ */
handleSearchFromURL();
</script>
<script>
function themVaoGio(id) {
    let gioHang = JSON.parse(localStorage.getItem("gioHang")) || [];

    const sanPham = danhSachSanPham.find(sp => sp.id === id);
    if (!sanPham) return;

    const tonTai = gioHang.find(item => item.id === id);

    if (tonTai) {
        tonTai.soLuong += 1;
    } else {
        gioHang.push({
            id: sanPham.id,
            tenSanPham: sanPham.tenSanPham,
            gia: sanPham.gia,
            hinhAnh: sanPham.hinhAnh,
            soLuong: 1
        });
    }

    localStorage.setItem("gioHang", JSON.stringify(gioHang));
    capNhatSoLuongGio();

    alert("‚úÖ ƒê√£ th√™m v√†o gi·ªè h√†ng");
}

function capNhatSoLuongGio() {
    let gioHang = JSON.parse(localStorage.getItem("gioHang")) || [];
    let tong = gioHang.reduce((sum, sp) => sum + sp.soLuong, 0);
    document.getElementById("cartCount").innerText = tong;
}
fetch("http://127.0.0.1:5000/api/gio-hang", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("token")
    },
    body: JSON.stringify({ sanPham_id: id, soLuong: 1 })
});

// khi load l·∫°i trang
capNhatSoLuongGio();
</script>

</body>
</html>
